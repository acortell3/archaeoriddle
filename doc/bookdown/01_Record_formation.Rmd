
# Record formation

## Introduction
We have produced an Agent-Based Model, replicating the process of formation of the archaeological record in a specific site, considering different variables. In order to consider the possible relation between those variables, we have decided to express them as a Directed Acyclic Graph (DAG), following the ECS-DAG methodology proposed by Ferguson et al. (2020). In this case, however, and because our goal is to obtain an accurate initial template for the development of the model, we have not considered setting an exposure variable, but rather to propose different theoretic directional and causal relationships without relying on the conventional exposure-outcome assessment. Therefore, highlights in the graph below do not intend to differentiate among confounders, mediators, etc., but to emphasize the possible weight that each variable has for producing the outcome (produced waste by $m^2$).

```{r, echo = FALSE}
library(DiagrammeR)

grViz("
digraph record_formation {

graph [layout = dot, ## Set title and layout
       label = 'Record formation process',
       labelloc = 't'
       fontname = Helvetica,
       fontsize = 30]

# node definitions with substituted label text
node [fontname = Helvetica, ## General node definition
      style = filled,
      color = MistyRose]
      
## Per node definition
a [label = '@@1',
   fillcolor = Orangered,
   fixedsize = shape,
   width = 3,
   height = 0.8,
   fontsize = 20]
b [label = '@@2']
c [label = '@@3',
   fillcolor = orange,
   fixedsize = shape,
   width = 4.5,
   height = 1,
   fontsize = 30]
d [label = '@@4',
   fillcolor = Orangered]
e [label = '@@5']
f [label = '@@6']
g [label = '@@7',
   fillcolor = Orangered,
   fixedsize = shape,
   width = 3,
   height = 0.8,
   fontsize = 20]
h [label = '@@8',
   fillcolor = Orangered]
i [label = '@@9']

## General edge definition
edge [color = grey,
       arrowhead = vee,
       arrowtail = vee]

## Specific edges
a -> {b c h}
b -> {c}
d -> {a b i} 
e -> {a b c h} 
f -> {a b c e h} 
g -> {a b c e f h} 
h -> {c} 
i -> {c} 
#c -> {b} [dir = both, label = 'per sqm']

}

## Label definition
[1]: 'Population'
[2]: 'Area'
[3]: 'Waste produced/sqrm'
[4]: 'Site type'
[5]: 'Site functionality'
[6]: 'Mobility pattern'
[7]: 'Economy type'
[8]: 'Anthropogenic deposition rates'
[9]: 'Other deposition rates'
")


```

We have considered the following random variables:

* **Waste produced per $m^2$ (outcome variable)**: The actual archaeological record present in each $m^2$. A discrete variable with range $[0,\propto K]$. $K$ being the population's carrying capacity.
* **Economy type**: This variable defines whether the group inhabiting the site is hunter-gatherer or a farmer group. Thus, it is a dichotomic variable.
* **Population**: The size of the group at each time step. Discrete variable with range $[0,\sim K]$.
* **Site type**: This represents whether the site is a cave, a rockshelter or an open-air site. Therefore, this is a categoric variable with three possible values.
* **Anthropogenic deposition rates**: The anthropogenic deposition rates are crucial for the formation of the archaeological record. This is a continuous variable with a range $[0,\infty]$. *The upper range must be reassessed based on literature*.
* **Mobility pattern**: In this case, we have considered different mobility strategies, which can affect, directly or indirectly, the formation of the record. We have considered three possible strategies: "residential", "logistic" and "sedentary". Thus, a categorical variable with three possible outcomes.
* **Site functionality**: Five different possible site uses have been considered: "habitat", "logistic", "pen", "butcher" and "funeral", giving a categorical variable with five possible outcomes.
* **Area**: The total site of the area is entangled with many other variables, and can have an effect in the final archaeological product. For simplicity, it has been considered as a discrete variable with range $[0,5000]$, measured in $m^2$, where the upper bound can be adapted to the site, if necessary.
* **Other deposition rates**: The same in nature as anthropogenic deposition rates, but different in its causality and effect. It is also considered as a continuous variable with range $[0,\infty]$. *The upper range must be reassessed based on literature*.

```{r}
# W <- [0,propK]
# Et <- factor('hg','f')
# Pop <- [0,K]
# St <- factor('c','rs','oa')
# Adr <- c()
# Mb <- factor('r','l','s')
# Sf <- factor('h','l','p','b','f')
# A <- c() [0,5000]
# Odr <- c()

```

## Set functions, initial conditions and caveats

These are the basic functions that we will be using
```{r}
## Function 1. Simulation of death process
#' @param pd: The probability matrix for mortality by age
death <- function(x,pd){
  age <- as.numeric(x[1])
  return(rbinom(1,1,prob = pd[pd$Age==age,2]))
}

## Function 2. Simluation of carrying capacity limitation
## If the population exceeds the carrying capacity, it eliminates oversize
## with 0.8 probability per person exceeding.
#' @param x: Data frame or matrix. Population (number of people)
#' @param k: Integer. Carrying capacity

K_lim <- function(x,k){
  p <- nrow(x)
  if (p>k){
    o <- rbinom(p-k,1,0.8)
    o <- sum(o[o==1])
    o[o==0] <- 1 ## Avoids problem eliminating all the df if remove == 0
    x <- x[-sample(1:nrow(x),o,replace = FALSE),]
  }
  return(x)
}
```

We must set some initial values and carrying capacities. Site economy will be implemented later

```{r}
ts <- 1000 # Time span
Gs_init <- 20 # Initial population
Gs_init <- data.frame("Age" = sample(10:30,Gs_init,10:30, replace = TRUE),
                      "Sex" = sample(c("M","F"), Gs_init, prob = c(0.5,0.5), replace = TRUE))

## K is determined by the site type and economy

## K <- 4-6 For rock-shelters
## K <- 15 small cave
## K <- 40 medium cave
K <- 70 ## large cave
## K <- 100 open-air (meso) depending on resources
## K <- 200 open-air (neo)

## Economy type. It can be HG or F
#ec <- "HG"

## Probability matrix for mortality
prob_d <- data.frame("Age" = c(0:99),
                     "P_d" = c(rep(0.13,2),
                               rep(0.08,8),
                               rep(0.01,25),
                               rep(0.1,15),
                               rep(0.15,10),
                               rep(0.25,5),
                               rep(0.99,35)))

```

Camp size depends on camp type (which can be rockshelter, cave or open-air)
If camp type = rockshelter or cave, a maximum size must be specified

We can preset values if the size of the camp is unknown
  - For rockshelters: small (4 sqrm), medium (15 sqrm), large (30 sqrm)
  - For caves: small (100 sqrm), medium (750 sqrm), large (1500 sqrm). More than this (or even within this). For more than this, subdivisions of the space are required.
  
If camp type = open-air, size increases as population size increases with a density 20 sqrm/person. Size constrains can be set also here.

For waste production, this is computed as total waste production / sqrm

## Birth-death process for a single site
```{r}
Pop <- Gs_init ## Population (Age and Sex)
p_y <- rep(NA,ts) ## Number of people per year
camp_size <- rep(NA,ts) ## Size of camp. Depends on people and type of camp

for (i in 1:ts){
  #Are born
  ## Female fertile population
  W <- Pop[Pop$Sex=="F",]
  W_fert <- W[W$Age>10 & W$Age<30,]
  
  ## Male fertile population
  M <- Pop[Pop$Sex=="M",]
  M_fert <- M[M$Age>15 & M$Age<40,]

  ## Probability of having descendance per woman
  # Penalisation in case there are too few men
  pen <- round(nrow(M_fert)*2/nrow(W_fert),2) ## Assumes one man can have two women
  pen[pen>1] <- 1
  
  ## 0.3 is drawn from ethnographic literature (each !Kung woman waits 3 years to have another son)
  P_o <- 0.3*pen

  Offspring <- sum(rbinom(nrow(W_fert),1,P_o))
  New_pop <- data.frame("Age" = rep(0,Offspring),
                        "Sex" = sample(c("M","F"),Offspring,prob=c(0.5,0.5),replace = TRUE))
  Pop <- rbind(Pop,New_pop)
  
  ## Die
  vec_d <- apply(Pop,1,death,prob_d)
  Pop <- Pop[vec_d==0,]
  
  ## Apply carrying capacty restrictions
  Pop <- K_lim(Pop, K)
  
  ## One year passes
  Pop$Age <- Pop$Age+1
  p_y[i] <- nrow(Pop)
}

plot(p_y, type = "l", col = "red",
     xlab = "Year", ylab = "Population",
     main = "Pop")
```

There are still many things to include, basically related to deposition rates, economy-related, waste generation... and I need to do a better text for this chapter. I'm on it.

