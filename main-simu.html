<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>5 Main Simulation | Archaeoriddle, the bookdown</title>
  <meta name="description" content="First draft of Rbookdown to describe how data have been generated" />
  <meta name="generator" content="bookdown 0.41 and GitBook 2.6.7" />

  <meta property="og:title" content="5 Main Simulation | Archaeoriddle, the bookdown" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="First draft of Rbookdown to describe how data have been generated" />
  <meta name="github-repo" content="acortell3/archaeoriddle" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="5 Main Simulation | Archaeoriddle, the bookdown" />
  
  <meta name="twitter:description" content="First draft of Rbookdown to describe how data have been generated" />
  

<meta name="author" content="by the Computational and Digital Archaeology Laboratory from Cambridge University" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
<link rel="prev" href="conflict.html"/>
<link rel="next" href="recgen.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<link href="libs/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet" />
<script src="libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
<script src="libs/viz-1.8.2/viz.js"></script>
<link href="libs/DiagrammeR-styles-0.2/styles.css" rel="stylesheet" />
<script src="libs/grViz-binding-1.0.11/grViz.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a></li>
<li class="chapter" data-level="1" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>1</b> Introduction</a>
<ul>
<li class="chapter" data-level="1.1" data-path="introduction.html"><a href="introduction.html#what-is-archaeoriddle"><i class="fa fa-check"></i><b>1.1</b> What is archaeoriddle?</a></li>
<li class="chapter" data-level="1.2" data-path="introduction.html"><a href="introduction.html#what-will-you-find-in-this-bookdown"><i class="fa fa-check"></i><b>1.2</b> What will you find in this bookdown?</a></li>
<li class="chapter" data-level="1.3" data-path="introduction.html"><a href="introduction.html#what-can-you-do-with-this"><i class="fa fa-check"></i><b>1.3</b> What can you do with this?</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="env.html"><a href="env.html"><i class="fa fa-check"></i><b>2</b> Landscape &amp; Resources</a>
<ul>
<li class="chapter" data-level="2.1" data-path="env.html"><a href="env.html#autocorrelated-noise-generation"><i class="fa fa-check"></i><b>2.1</b> Autocorrelated noise generation</a></li>
<li class="chapter" data-level="2.2" data-path="env.html"><a href="env.html#slope-and-elevation"><i class="fa fa-check"></i><b>2.2</b> Slope and Elevation</a></li>
<li class="chapter" data-level="2.3" data-path="env.html"><a href="env.html#environmental-resources"><i class="fa fa-check"></i><b>2.3</b> Environmental resources</a></li>
<li class="chapter" data-level="2.4" data-path="env.html"><a href="env.html#manual-selection"><i class="fa fa-check"></i><b>2.4</b> Manually Select Resources</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="popgrowth.html"><a href="popgrowth.html"><i class="fa fa-check"></i><b>3</b> Population structure &amp; growth</a>
<ul>
<li class="chapter" data-level="3.1" data-path="popgrowth.html"><a href="popgrowth.html#settlements-position"><i class="fa fa-check"></i><b>3.1</b> Settlements position</a></li>
<li class="chapter" data-level="3.2" data-path="popgrowth.html"><a href="popgrowth.html#initsize"><i class="fa fa-check"></i><b>3.2</b> Initializing Site Population and Culture</a></li>
<li class="chapter" data-level="3.3" data-path="popgrowth.html"><a href="popgrowth.html#base-pop-growth"><i class="fa fa-check"></i><b>3.3</b> Population Growth : <span class="math inline">\(Pop\)</span>-protocol</a>
<ul>
<li class="chapter" data-level="" data-path="popgrowth.html"><a href="popgrowth.html#source"><i class="fa fa-check"></i>Source</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="conflict.html"><a href="conflict.html"><i class="fa fa-check"></i><b>4</b> Migration &amp; Conflict</a>
<ul>
<li class="chapter" data-level="4.1" data-path="conflict.html"><a href="conflict.html#fission"><i class="fa fa-check"></i><b>4.1</b> Fission</a></li>
<li class="chapter" data-level="4.2" data-path="conflict.html"><a href="conflict.html#migration"><i class="fa fa-check"></i><b>4.2</b> Migration</a></li>
<li class="chapter" data-level="4.3" data-path="conflict.html"><a href="conflict.html#conflict-and-war"><i class="fa fa-check"></i><b>4.3</b> Conflict and War</a></li>
<li class="chapter" data-level="4.4" data-path="conflict.html"><a href="conflict.html#deprecated-network-site-size-and-climate"><i class="fa fa-check"></i><b>4.4</b> DEPRECATED – Network, Site Size And Climate</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="main-simu.html"><a href="main-simu.html"><i class="fa fa-check"></i><b>5</b> Main Simulation</a>
<ul>
<li class="chapter" data-level="5.1" data-path="main-simu.html"><a href="main-simu.html#initial-parameters"><i class="fa fa-check"></i><b>5.1</b> Initial Parameters</a></li>
<li class="chapter" data-level="5.2" data-path="main-simu.html"><a href="main-simu.html#preparation"><i class="fa fa-check"></i><b>5.2</b> Preparation</a></li>
<li class="chapter" data-level="5.3" data-path="main-simu.html"><a href="main-simu.html#algorithm"><i class="fa fa-check"></i><b>5.3</b> Algorithm</a>
<ul>
<li class="chapter" data-level="" data-path="main-simu.html"><a href="main-simu.html#source-code"><i class="fa fa-check"></i>Source code</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="main-simu.html"><a href="main-simu.html#explore-simulation"><i class="fa fa-check"></i><b>5.4</b> Explore simulation</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="recgen.html"><a href="recgen.html"><i class="fa fa-check"></i><b>6</b> Record formation</a>
<ul>
<li class="chapter" data-level="6.1" data-path="recgen.html"><a href="recgen.html#theoretical-model"><i class="fa fa-check"></i><b>6.1</b> Theoretical model</a></li>
<li class="chapter" data-level="6.2" data-path="recgen.html"><a href="recgen.html#implementation"><i class="fa fa-check"></i><b>6.2</b> Implementation</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="recgen.html"><a href="recgen.html#population-pop-protocol"><i class="fa fa-check"></i><b>6.2.1</b> Population <span class="math inline">\(Pop\)</span>-protocol</a></li>
<li class="chapter" data-level="6.2.2" data-path="recgen.html"><a href="recgen.html#anthropogenic-deposition-a-protocol"><i class="fa fa-check"></i><b>6.2.2</b> Anthropogenic deposition <span class="math inline">\(A\)</span>-protocol</a></li>
<li class="chapter" data-level="6.2.3" data-path="recgen.html"><a href="recgen.html#depth-d-protocol"><i class="fa fa-check"></i><b>6.2.3</b> Depth <span class="math inline">\(D\)</span>-protocol</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="recgen.html"><a href="recgen.html#minimal-example-and-simulation"><i class="fa fa-check"></i><b>6.3</b> Minimal example and simulation</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="recloss.html"><a href="recloss.html"><i class="fa fa-check"></i><b>7</b> Record loss</a>
<ul>
<li class="chapter" data-level="7.1" data-path="recloss.html"><a href="recloss.html#theoretical-model-1"><i class="fa fa-check"></i><b>7.1</b> Theoretical model</a>
<ul>
<li class="chapter" data-level="7.1.1" data-path="recloss.html"><a href="recloss.html#general-purpose"><i class="fa fa-check"></i><b>7.1.1</b> General purpose</a></li>
<li class="chapter" data-level="7.1.2" data-path="recloss.html"><a href="recloss.html#model-layers"><i class="fa fa-check"></i><b>7.1.2</b> Model layers</a></li>
</ul></li>
<li class="chapter" data-level="7.2" data-path="recloss.html"><a href="recloss.html#implementation-1"><i class="fa fa-check"></i><b>7.2</b> Implementation</a>
<ul>
<li class="chapter" data-level="" data-path="recloss.html"><a href="recloss.html#source-1"><i class="fa fa-check"></i>Source</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="recloss.html"><a href="recloss.html#usage"><i class="fa fa-check"></i><b>7.3</b> Usage</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="final-output.html"><a href="final-output.html"><i class="fa fa-check"></i><b>8</b> Generate final archaeological record</a>
<ul>
<li class="chapter" data-level="8.1" data-path="final-output.html"><a href="final-output.html#using-sites-size-to-generate-deposit"><i class="fa fa-check"></i><b>8.1</b> Using sites size to generate deposit</a></li>
<li class="chapter" data-level="8.2" data-path="final-output.html"><a href="final-output.html#provide-survey-square-and-publicly-available-dates"><i class="fa fa-check"></i><b>8.2</b> Provide survey square and publicly available dates</a>
<ul>
<li class="chapter" data-level="8.2.1" data-path="final-output.html"><a href="final-output.html#giving-name-to-the-publicly-available-data"><i class="fa fa-check"></i><b>8.2.1</b> Giving name to the publicly available data</a></li>
<li class="chapter" data-level="8.2.2" data-path="final-output.html"><a href="final-output.html#export-and-download-dates"><i class="fa fa-check"></i><b>8.2.2</b> Export and download dates</a></li>
</ul></li>
<li class="chapter" data-level="8.3" data-path="final-output.html"><a href="final-output.html#bonus-maps"><i class="fa fa-check"></i><b>8.3</b> Bonus maps</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="original-challenge.html"><a href="original-challenge.html"><i class="fa fa-check"></i><b>9</b> Archaeoriddle: the original challenge</a>
<ul>
<li class="chapter" data-level="9.1" data-path="original-challenge.html"><a href="original-challenge.html#context"><i class="fa fa-check"></i><b>9.1</b> Context</a>
<ul>
<li class="chapter" data-level="9.1.1" data-path="original-challenge.html"><a href="original-challenge.html#original-idea-and-first-reflections"><i class="fa fa-check"></i><b>9.1.1</b> Original idea and first reflections</a></li>
<li class="chapter" data-level="9.1.2" data-path="original-challenge.html"><a href="original-challenge.html#birth-of-a-challenge"><i class="fa fa-check"></i><b>9.1.2</b> Birth of a Challenge</a></li>
<li class="chapter" data-level="9.1.3" data-path="original-challenge.html"><a href="original-challenge.html#the-british-academy-grant-november-2022"><i class="fa fa-check"></i><b>9.1.3</b> The British Academy Grant – November 2022</a></li>
<li class="chapter" data-level="9.1.4" data-path="original-challenge.html"><a href="original-challenge.html#caa-oxford-june-2023"><i class="fa fa-check"></i><b>9.1.4</b> CAA Oxford – June 2023</a></li>
<li class="chapter" data-level="9.1.5" data-path="original-challenge.html"><a href="original-challenge.html#the-eaa-call-for-proposal-august-2023"><i class="fa fa-check"></i><b>9.1.5</b> The EAA call for proposal – August 2023</a></li>
</ul></li>
<li class="chapter" data-level="9.2" data-path="original-challenge.html"><a href="original-challenge.html#implementation-2"><i class="fa fa-check"></i><b>9.2</b> Implementation</a></li>
<li class="chapter" data-level="9.3" data-path="original-challenge.html"><a href="original-challenge.html#lets-rewind-the-tape"><i class="fa fa-check"></i><b>9.3</b> Let’s rewind the tape</a>
<ul>
<li class="chapter" data-level="9.3.1" data-path="original-challenge.html"><a href="original-challenge.html#generate-and-share-final-simulation"><i class="fa fa-check"></i><b>9.3.1</b> Generate and share final simulation</a></li>
<li class="chapter" data-level="9.3.2" data-path="original-challenge.html"><a href="original-challenge.html#grid-generation-and-sharing"><i class="fa fa-check"></i><b>9.3.2</b> Grid generation and sharing</a></li>
<li class="chapter" data-level="9.3.3" data-path="original-challenge.html"><a href="original-challenge.html#naming"><i class="fa fa-check"></i><b>9.3.3</b> Giving name to the publicly available data</a></li>
</ul></li>
<li class="chapter" data-level="9.4" data-path="original-challenge.html"><a href="original-challenge.html#the-proposals"><i class="fa fa-check"></i><b>9.4</b> The proposals</a>
<ul>
<li class="chapter" data-level="9.4.1" data-path="original-challenge.html"><a href="original-challenge.html#p1"><i class="fa fa-check"></i><b>9.4.1</b> P1</a></li>
<li class="chapter" data-level="9.4.2" data-path="original-challenge.html"><a href="original-challenge.html#p2"><i class="fa fa-check"></i><b>9.4.2</b> P2</a></li>
<li class="chapter" data-level="9.4.3" data-path="original-challenge.html"><a href="original-challenge.html#p3"><i class="fa fa-check"></i><b>9.4.3</b> P3</a></li>
<li class="chapter" data-level="9.4.4" data-path="original-challenge.html"><a href="original-challenge.html#p4"><i class="fa fa-check"></i><b>9.4.4</b> P4</a></li>
<li class="chapter" data-level="9.4.5" data-path="original-challenge.html"><a href="original-challenge.html#p5"><i class="fa fa-check"></i><b>9.4.5</b> P5</a></li>
</ul></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/acortell3/archaeoriddle/">
source</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Archaeoriddle, the bookdown</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="main-simu" class="section level1 hasAnchor" number="5">
<h1><span class="header-section-number">5</span> Main Simulation<a href="main-simu.html#main-simu" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="initial-parameters" class="section level2 hasAnchor" number="5.1">
<h2><span class="header-section-number">5.1</span> Initial Parameters<a href="main-simu.html#initial-parameters" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>We now have sites with two cultures, a environment and function to make population growth, migrate and engages into wars. Each function depends on a lot of paramaters, some have been reviewd before other are explain in the help of each function. Often the parameters can differs between the two cultures. He we gave a list of parameters, close to those used during the Archaeoriddle challenge:</p>
</div>
<div id="preparation" class="section level2 hasAnchor" number="5.2">
<h2><span class="header-section-number">5.2</span> Preparation<a href="main-simu.html#preparation" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>We will create antoher older <code>data_tmp</code> where we will store useful file, that won’t be shared to everyone but will be used at some point or another.</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="main-simu.html#cb42-1" tabindex="-1"></a>foldtmp<span class="ot">=</span><span class="st">&quot;data_tmp&quot;</span> <span class="co">#We will store all data that can/will be shared with participant in data_toshare</span></span>
<span id="cb42-2"><a href="main-simu.html#cb42-2" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(foldtmp))<span class="fu">dir.create</span>(foldtmp)</span></code></pre></div>
<p>We setup all paramaters</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="main-simu.html#cb43-1" tabindex="-1"></a></span>
<span id="cb43-2"><a href="main-simu.html#cb43-2" tabindex="-1"></a><span class="co">#initialisation</span></span>
<span id="cb43-3"><a href="main-simu.html#cb43-3" tabindex="-1"></a></span>
<span id="cb43-4"><a href="main-simu.html#cb43-4" tabindex="-1"></a>Kbase<span class="ot">=</span><span class="fu">c</span>(<span class="st">&quot;HG&quot;</span><span class="ot">=</span><span class="dv">45</span>,<span class="st">&quot;F&quot;</span><span class="ot">=</span><span class="dv">120</span>) <span class="co">#difference in K for the two cultures use and defined before ; will be use in simulation to define new site</span></span>
<span id="cb43-5"><a href="main-simu.html#cb43-5" tabindex="-1"></a></span>
<span id="cb43-6"><a href="main-simu.html#cb43-6" tabindex="-1"></a><span class="co"># spatial penality for cultural extentions, ie for population to move out of initial site : lower, bigger penality</span></span>
<span id="cb43-7"><a href="main-simu.html#cb43-7" tabindex="-1"></a>cul_ext <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;HG&quot;</span><span class="ot">=</span><span class="dv">7</span>, <span class="st">&quot;F&quot;</span><span class="ot">=</span><span class="dv">6</span>)</span>
<span id="cb43-8"><a href="main-simu.html#cb43-8" tabindex="-1"></a></span>
<span id="cb43-9"><a href="main-simu.html#cb43-9" tabindex="-1"></a><span class="co"># penality of occupational area ie how hard it is to come close to your site ; if low, other sites can come close</span></span>
<span id="cb43-10"><a href="main-simu.html#cb43-10" tabindex="-1"></a>penal_cul <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;HG&quot;</span><span class="ot">=</span><span class="dv">4</span>, <span class="st">&quot;F&quot;</span><span class="ot">=</span><span class="dv">5</span>)</span>
<span id="cb43-11"><a href="main-simu.html#cb43-11" tabindex="-1"></a><span class="co"># proba to give birth every year</span></span>
<span id="cb43-12"><a href="main-simu.html#cb43-12" tabindex="-1"></a>prob_birth <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;HG&quot;</span><span class="ot">=</span><span class="fl">0.3</span>, <span class="st">&quot;F&quot;</span><span class="ot">=</span><span class="fl">0.5</span>)</span>
<span id="cb43-13"><a href="main-simu.html#cb43-13" tabindex="-1"></a><span class="co"># proba to die when pop &gt; K</span></span>
<span id="cb43-14"><a href="main-simu.html#cb43-14" tabindex="-1"></a>prob_survive <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;HG&quot;</span><span class="ot">=</span><span class="fl">0.8</span>, <span class="st">&quot;F&quot;</span><span class="ot">=</span><span class="fl">0.6</span>)</span>
<span id="cb43-15"><a href="main-simu.html#cb43-15" tabindex="-1"></a><span class="co"># proba to create new settlement when Ne &gt; K</span></span>
<span id="cb43-16"><a href="main-simu.html#cb43-16" tabindex="-1"></a>prob_split <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;HG&quot;</span><span class="ot">=</span><span class="fl">0.2</span>, <span class="st">&quot;F&quot;</span><span class="ot">=</span><span class="fl">0.6</span>)</span>
<span id="cb43-17"><a href="main-simu.html#cb43-17" tabindex="-1"></a><span class="co"># how big the group of migrant should be to create a new city vs</span></span>
<span id="cb43-18"><a href="main-simu.html#cb43-18" tabindex="-1"></a><span class="co"># migrate to a existing one</span></span>
<span id="cb43-19"><a href="main-simu.html#cb43-19" tabindex="-1"></a>minimals <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;HG&quot;</span><span class="ot">=</span><span class="fl">0.14</span>, <span class="st">&quot;F&quot;</span><span class="ot">=</span><span class="fl">0.20</span>)</span>
<span id="cb43-20"><a href="main-simu.html#cb43-20" tabindex="-1"></a><span class="co"># prob to migrate to existing settlement when Ne &gt; K</span></span>
<span id="cb43-21"><a href="main-simu.html#cb43-21" tabindex="-1"></a>prob_move <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;HG&quot;</span><span class="ot">=</span><span class="fl">0.2</span>,<span class="st">&quot;F&quot;</span><span class="ot">=</span><span class="fl">0.1</span>)</span></code></pre></div>
<p>Let’s see our raster map again, and put the sites on top, with their ids and showing there initial population size:</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="main-simu.html#cb44-1" tabindex="-1"></a><span class="fu">plotMap</span>(height.ras,height.wat,<span class="fu">paste0</span>(<span class="st">&quot;year &quot;</span>, <span class="dv">0</span>))</span>
<span id="cb44-2"><a href="main-simu.html#cb44-2" tabindex="-1"></a><span class="fu">plot</span>(sites, <span class="at">pch=</span><span class="dv">21</span>, <span class="at">add=</span>T, <span class="at">bg=</span><span class="fu">rainbow</span>(<span class="dv">2</span>, <span class="at">alpha=</span><span class="fl">0.6</span>)[<span class="fu">as.factor</span>(sites<span class="sc">$</span>culture)],<span class="at">cex=</span>(<span class="dv">1</span><span class="sc">+</span>Nts[<span class="dv">1</span>,]<span class="sc">/</span><span class="dv">100</span>))</span>
<span id="cb44-3"><a href="main-simu.html#cb44-3" tabindex="-1"></a><span class="fu">text</span>(sites,<span class="at">pos=</span><span class="dv">3</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/mapagain-1.png" width="672" /></p>
<p>The <code>run_simulation</code> function will take the raster data and parameters for defined before for the two different cultures and run for the specified number of years <code>ts</code> (250).</p>
<p>It will then call the functions described above to model contacts between sites, the outcomes of fights and migrations. If you want</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="main-simu.html#cb45-1" tabindex="-1"></a>?run_simulation</span>
<span id="cb45-2"><a href="main-simu.html#cb45-2" tabindex="-1"></a>?whotouch</span>
<span id="cb45-3"><a href="main-simu.html#cb45-3" tabindex="-1"></a>?fightbetterloss</span>
<span id="cb45-4"><a href="main-simu.html#cb45-4" tabindex="-1"></a>?changePopSize</span>
<span id="cb45-5"><a href="main-simu.html#cb45-5" tabindex="-1"></a>?warpoints</span></code></pre></div>
</div>
<div id="algorithm" class="section level2 hasAnchor" number="5.3">
<h2><span class="header-section-number">5.3</span> Algorithm<a href="main-simu.html#algorithm" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The general organisation of the algorithm is as follow:</p>
<blockquote>
<p>initialisation
for all sites s:
N_s &lt;- growth(N_s)
if(N_s&gt;K_s):
moving people:
if( N_s - K-S &gt; min_s * K_s and probsplit_s):
create new city:
find the closest most attractive spot and move there
else if(proba move ):
migration
war(s)</p>
</blockquote>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="main-simu.html#cb46-1" tabindex="-1"></a></span>
<span id="cb46-2"><a href="main-simu.html#cb46-2" tabindex="-1"></a><span class="fl">1.</span> <span class="sc">**</span> initialisation <span class="sc">**</span></span>
<span id="cb46-3"><a href="main-simu.html#cb46-3" tabindex="-1"></a>  </span>
<span id="cb46-4"><a href="main-simu.html#cb46-4" tabindex="-1"></a><span class="fl">2.</span> <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>(ts<span class="sc">+</span><span class="dv">1</span>))</span>
<span id="cb46-5"><a href="main-simu.html#cb46-5" tabindex="-1"></a>    inactives <span class="ot">&lt;-</span> (Nts[i<span class="dv">-1</span>,]<span class="sc">==</span><span class="dv">0</span>)</span>
<span id="cb46-6"><a href="main-simu.html#cb46-6" tabindex="-1"></a>    <span class="cf">for</span> ( s <span class="cf">in</span> <span class="fu">sample</span>(<span class="fu">seq_along</span>(sites)[<span class="sc">!</span>inactives]) <span class="sc">:</span> <span class="co">#among all active site</span></span>
<span id="cb46-7"><a href="main-simu.html#cb46-7" tabindex="-1"></a>        N_s <span class="ot">&lt;-</span> <span class="fu">Gpd</span>()</span>
<span id="cb46-8"><a href="main-simu.html#cb46-8" tabindex="-1"></a>        <span class="cf">if</span> <span class="sc">$</span>N_s<span class="sc">&gt;</span> K_s<span class="sc">$</span> <span class="er">:</span></span>
<span id="cb46-9"><a href="main-simu.html#cb46-9" tabindex="-1"></a>            migrants <span class="ot">&lt;-</span> newN <span class="sc">-</span> <span class="fu">round</span>(Ks[[s]]<span class="sc">*</span><span class="fl">0.9</span>)</span>
<span id="cb46-10"><a href="main-simu.html#cb46-10" tabindex="-1"></a>            <span class="cf">if</span> (migrants <span class="sc">&gt;=</span> (minimals[sites<span class="sc">$</span>culture[s]]<span class="sc">*</span>sites<span class="sc">$</span>Ks[s]) <span class="sc">&amp;</span> <span class="fu">runif</span>(<span class="dv">1</span>)<span class="sc">&lt;</span>prob_split[sites<span class="sc">$</span>culture[s]] ){</span>
<span id="cb46-11"><a href="main-simu.html#cb46-11" tabindex="-1"></a>          <span class="co">#if subpopulation &gt; 10 people, 10% chance of creation of a new city</span></span>
<span id="cb46-12"><a href="main-simu.html#cb46-12" tabindex="-1"></a></span>
<span id="cb46-13"><a href="main-simu.html#cb46-13" tabindex="-1"></a>          infarea <span class="ot">&lt;-</span> (<span class="fu">sqrt</span>(tmp)<span class="sc">+</span>penal_cul[cultures]) <span class="sc">*</span> buffersettl</span>
<span id="cb46-14"><a href="main-simu.html#cb46-14" tabindex="-1"></a>          buffersize <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="fu">length</span>(infarea), infarea, infarea <span class="sc">*</span> <span class="fl">0.1</span>)</span>
<span id="cb46-15"><a href="main-simu.html#cb46-15" tabindex="-1"></a>          buffersize[tmp<span class="sc">==</span><span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb46-16"><a href="main-simu.html#cb46-16" tabindex="-1"></a>          territory <span class="ot">&lt;-</span> <span class="fu">erase</span>(viable, <span class="fu">buffer</span>(sites, buffersize))</span>
<span id="cb46-17"><a href="main-simu.html#cb46-17" tabindex="-1"></a>          </span>
<span id="cb46-18"><a href="main-simu.html#cb46-18" tabindex="-1"></a>          <span class="cf">if</span>( <span class="fu">length</span>(territory)<span class="sc">&gt;</span><span class="dv">0</span> ){</span>
<span id="cb46-19"><a href="main-simu.html#cb46-19" tabindex="-1"></a>            <span class="do">##select a new site given its distance to the old one and the ressourcesource available in ressources</span></span>
<span id="cb46-20"><a href="main-simu.html#cb46-20" tabindex="-1"></a>            d2 <span class="ot">&lt;-</span> <span class="fu">logisticdecay</span>( sites[s], dem, <span class="at">x=</span><span class="dv">20000</span><span class="sc">*</span>cul_ext[sites<span class="sc">$</span>culture[s]])</span>
<span id="cb46-21"><a href="main-simu.html#cb46-21" tabindex="-1"></a>            w <span class="ot">&lt;-</span> (<span class="fl">0.7</span> <span class="sc">*</span> d2 <span class="sc">+</span> <span class="fl">0.3</span><span class="sc">*</span>ressources) <span class="sc">/</span> (<span class="fl">0.7</span><span class="sc">*</span><span class="fu">minmax</span>(d2)[<span class="dv">2</span>] <span class="sc">+</span> <span class="fl">0.3</span><span class="sc">*</span><span class="fu">minmax</span>(ressources)[<span class="dv">2</span>])</span>
<span id="cb46-22"><a href="main-simu.html#cb46-22" tabindex="-1"></a>            new_site <span class="ot">&lt;-</span> <span class="fu">spatSample</span>(</span>
<span id="cb46-23"><a href="main-simu.html#cb46-23" tabindex="-1"></a>              <span class="at">x=</span><span class="fu">mask</span>(</span>
<span id="cb46-24"><a href="main-simu.html#cb46-24" tabindex="-1"></a>                w <span class="sc">*</span> <span class="fu">logisticdecay</span>(sites[s], dem, <span class="at">k=</span><span class="fl">0.00002</span>,</span>
<span id="cb46-25"><a href="main-simu.html#cb46-25" tabindex="-1"></a>                                  <span class="at">x=</span><span class="dv">20000</span><span class="sc">*</span>cul_ext[sites<span class="sc">$</span>culture[s]]),</span>
<span id="cb46-26"><a href="main-simu.html#cb46-26" tabindex="-1"></a>                territory),</span>
<span id="cb46-27"><a href="main-simu.html#cb46-27" tabindex="-1"></a>              <span class="at">size=</span><span class="dv">1</span>, <span class="at">method=</span><span class="st">&quot;weights&quot;</span>, <span class="at">xy=</span>T)[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]</span>
<span id="cb46-28"><a href="main-simu.html#cb46-28" tabindex="-1"></a>            new_site <span class="ot">&lt;-</span> <span class="fu">vect</span>(new_site, <span class="at">geom=</span><span class="fu">c</span>(<span class="st">&quot;x&quot;</span>,<span class="st">&quot;y&quot;</span>))</span>
<span id="cb46-29"><a href="main-simu.html#cb46-29" tabindex="-1"></a>            </span>
<span id="cb46-30"><a href="main-simu.html#cb46-30" tabindex="-1"></a>            <span class="cf">if</span> ( <span class="fu">length</span>(new_site)<span class="sc">&gt;</span><span class="dv">0</span> <span class="sc">&amp;</span> <span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(<span class="fu">crds</span>(new_site))) ){</span>
<span id="cb46-31"><a href="main-simu.html#cb46-31" tabindex="-1"></a>              <span class="do">##add new site to site listes</span></span>
<span id="cb46-32"><a href="main-simu.html#cb46-32" tabindex="-1"></a>              Ips[[<span class="fu">length</span>(Ips)<span class="sc">+</span><span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fu">initpopstruc</span>(<span class="at">n=</span>migrants) <span class="co">#initialise a fake populaition, will be updated by real migrants later</span></span>
<span id="cb46-33"><a href="main-simu.html#cb46-33" tabindex="-1"></a>              new_site<span class="sc">$</span>culture <span class="ot">&lt;-</span> sites<span class="sc">$</span>culture[s]</span>
<span id="cb46-34"><a href="main-simu.html#cb46-34" tabindex="-1"></a>              new_site<span class="sc">$</span>Ks <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">initKs</span>(</span>
<span id="cb46-35"><a href="main-simu.html#cb46-35" tabindex="-1"></a>                Kbase, <span class="at">sites=</span>new_site, ressources,</span>
<span id="cb46-36"><a href="main-simu.html#cb46-36" tabindex="-1"></a>                <span class="at">sizeex=</span><span class="st">&quot;F&quot;</span>, <span class="at">rate=</span><span class="fl">0.45</span>))</span>
<span id="cb46-37"><a href="main-simu.html#cb46-37" tabindex="-1"></a>              sites <span class="ot">&lt;-</span> <span class="fu">rbind</span>(sites, new_site)</span>
<span id="cb46-38"><a href="main-simu.html#cb46-38" tabindex="-1"></a>              Ks[<span class="fu">length</span>(Ks)<span class="sc">+</span><span class="dv">1</span>] <span class="ot">&lt;-</span> new_site<span class="sc">$</span>Ks</span>
<span id="cb46-39"><a href="main-simu.html#cb46-39" tabindex="-1"></a>            }</span>
<span id="cb46-40"><a href="main-simu.html#cb46-40" tabindex="-1"></a>          }</span>
<span id="cb46-41"><a href="main-simu.html#cb46-41" tabindex="-1"></a>        }</span>
<span id="cb46-42"><a href="main-simu.html#cb46-42" tabindex="-1"></a>        <span class="do">## if no creation of new city happen, there is a certain probability that people will move</span></span>
<span id="cb46-43"><a href="main-simu.html#cb46-43" tabindex="-1"></a>        <span class="cf">if</span>( <span class="fu">length</span>(new_site)<span class="sc">==</span><span class="dv">0</span> <span class="sc">&amp;&amp;</span> <span class="fu">runif</span>(<span class="dv">1</span>) <span class="sc">&lt;</span> prob_move[sites<span class="sc">$</span>culture[s]] ){</span>
<span id="cb46-44"><a href="main-simu.html#cb46-44" tabindex="-1"></a>           <span class="co">#migration to existing site</span></span>
<span id="cb46-45"><a href="main-simu.html#cb46-45" tabindex="-1"></a>          att <span class="ot">&lt;-</span> <span class="fu">extract</span>(ressources,sites)[,<span class="dv">2</span>]</span>
<span id="cb46-46"><a href="main-simu.html#cb46-46" tabindex="-1"></a>          space <span class="ot">&lt;-</span> sites<span class="sc">$</span>Ks <span class="sc">-</span> (Nts[i<span class="dv">-1</span>,] <span class="sc">+</span> migrants)</span>
<span id="cb46-47"><a href="main-simu.html#cb46-47" tabindex="-1"></a>          dis <span class="ot">&lt;-</span> <span class="fu">extract</span>(<span class="fu">logisticdecay</span>(sites[s], dem, <span class="at">k=</span><span class="fl">0.00002</span>, <span class="at">x=</span><span class="dv">1</span>), sites)[,<span class="dv">2</span>]</span>
<span id="cb46-48"><a href="main-simu.html#cb46-48" tabindex="-1"></a>          attractivity <span class="ot">&lt;-</span> att <span class="sc">*</span> space <span class="sc">*</span> dis</span>
<span id="cb46-49"><a href="main-simu.html#cb46-49" tabindex="-1"></a>          <span class="co">#attractivity=attractivity*(1+10*(sites$culture[s]==sites$culture)) #4 times more likely to go to similar culture</span></span>
<span id="cb46-50"><a href="main-simu.html#cb46-50" tabindex="-1"></a>          attractivity[s] <span class="ot">&lt;-</span> <span class="fu">min</span>(attractivity)<span class="sc">-</span><span class="dv">1</span></span>
<span id="cb46-51"><a href="main-simu.html#cb46-51" tabindex="-1"></a>          attractivity <span class="ot">&lt;-</span> <span class="fu">exp</span>(attractivity)<span class="sc">/</span><span class="fu">sum</span>(<span class="fu">exp</span>(attractivity))</span>
<span id="cb46-52"><a href="main-simu.html#cb46-52" tabindex="-1"></a>          attractivity[Nts[i<span class="dv">-1</span>,]<span class="sc">&lt;</span><span class="dv">10</span>] <span class="ot">&lt;-</span> <span class="dv">0</span> </span>
<span id="cb46-53"><a href="main-simu.html#cb46-53" tabindex="-1"></a>          attractivity[sites<span class="sc">$</span>culture<span class="sc">!=</span>sites<span class="sc">$</span>culture[s]] <span class="ot">&lt;-</span> <span class="dv">0</span> </span>
<span id="cb46-54"><a href="main-simu.html#cb46-54" tabindex="-1"></a>          <span class="cf">if</span>(<span class="fu">any</span>(<span class="fu">is.na</span>(attractivity))){</span>
<span id="cb46-55"><a href="main-simu.html#cb46-55" tabindex="-1"></a>            <span class="fu">print</span>(attractivity)</span>
<span id="cb46-56"><a href="main-simu.html#cb46-56" tabindex="-1"></a>            attractivity[<span class="fu">is.na</span>(attractivity)] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb46-57"><a href="main-simu.html#cb46-57" tabindex="-1"></a>          }</span>
<span id="cb46-58"><a href="main-simu.html#cb46-58" tabindex="-1"></a>          </span>
<span id="cb46-59"><a href="main-simu.html#cb46-59" tabindex="-1"></a>          city <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="at">size=</span><span class="dv">1</span>, <span class="at">x=</span><span class="fu">seq_along</span>(sites), <span class="at">prob=</span>attractivity)</span>
<span id="cb46-60"><a href="main-simu.html#cb46-60" tabindex="-1"></a>          Nts[i,city] <span class="ot">&lt;-</span> Nts[i<span class="dv">-1</span>,city] <span class="sc">+</span> migrants</span>
<span id="cb46-61"><a href="main-simu.html#cb46-61" tabindex="-1"></a>        }</span>
<span id="cb46-62"><a href="main-simu.html#cb46-62" tabindex="-1"></a>        <span class="cf">if</span>( havemoved ){</span>
<span id="cb46-63"><a href="main-simu.html#cb46-63" tabindex="-1"></a>          Ips[<span class="fu">c</span>(s,city)] <span class="ot">&lt;-</span> <span class="fu">changePopSize</span>( <span class="at">loosingPop=</span>Ips[[s]], <span class="at">winingPop=</span>Ips[[city]], <span class="at">size=</span>migrants)</span>
<span id="cb46-64"><a href="main-simu.html#cb46-64" tabindex="-1"></a>          newN <span class="ot">&lt;-</span> newN <span class="sc">-</span> migrants</span>
<span id="cb46-65"><a href="main-simu.html#cb46-65" tabindex="-1"></a>        }</span>
<span id="cb46-66"><a href="main-simu.html#cb46-66" tabindex="-1"></a>        </span>
<span id="cb46-67"><a href="main-simu.html#cb46-67" tabindex="-1"></a>      <span class="er">}</span></span>
<span id="cb46-68"><a href="main-simu.html#cb46-68" tabindex="-1"></a>      Nts[i,s] <span class="ot">&lt;-</span> newN</span>
<span id="cb46-69"><a href="main-simu.html#cb46-69" tabindex="-1"></a>      </span>
<span id="cb46-70"><a href="main-simu.html#cb46-70" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb46-71"><a href="main-simu.html#cb46-71" tabindex="-1"></a>    <span class="do">## WAR =======================</span></span>
<span id="cb46-72"><a href="main-simu.html#cb46-72" tabindex="-1"></a>    potentialfighters <span class="ot">&lt;-</span> <span class="fu">which</span>(sites<span class="sc">$</span>culture<span class="sc">==</span><span class="st">&quot;F&quot;</span> <span class="sc">&amp;</span> Nts[i,]<span class="sc">&gt;</span><span class="dv">50</span>)</span>
<span id="cb46-73"><a href="main-simu.html#cb46-73" tabindex="-1"></a>    <span class="cf">for</span> (s <span class="cf">in</span> <span class="fu">sample</span>(<span class="at">x=</span>potentialfighters, <span class="at">size=</span><span class="fu">round</span>(<span class="fu">length</span>(potentialfighters)<span class="sc">*</span><span class="fl">0.1</span>))){</span>
<span id="cb46-74"><a href="main-simu.html#cb46-74" tabindex="-1"></a>      buff <span class="ot">&lt;-</span> bufferatack</span>
<span id="cb46-75"><a href="main-simu.html#cb46-75" tabindex="-1"></a>      potentialvictims <span class="ot">&lt;-</span> <span class="fu">which</span>(sites<span class="sc">$</span>culture <span class="sc">!=</span>sites<span class="sc">$</span>culture[s] <span class="sc">&amp;</span> Nts[i,]<span class="sc">&gt;</span><span class="dv">0</span>) </span>
<span id="cb46-76"><a href="main-simu.html#cb46-76" tabindex="-1"></a>      clash <span class="ot">&lt;-</span> <span class="fu">whotouch</span>(s, sites, <span class="at">Ne=</span>Nts[i,], <span class="at">buffersize=</span>buff)</span>
<span id="cb46-77"><a href="main-simu.html#cb46-77" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">length</span>(clash)<span class="sc">&gt;</span><span class="dv">0</span> <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(clash)){</span>
<span id="cb46-78"><a href="main-simu.html#cb46-78" tabindex="-1"></a>        <span class="cf">if</span>(<span class="fu">length</span>(clash) <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb46-79"><a href="main-simu.html#cb46-79" tabindex="-1"></a>          attack <span class="ot">&lt;-</span> clash</span>
<span id="cb46-80"><a href="main-simu.html#cb46-80" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb46-81"><a href="main-simu.html#cb46-81" tabindex="-1"></a>          attack <span class="ot">&lt;-</span> <span class="fu">sample</span>(clash, <span class="dv">1</span>)</span>
<span id="cb46-82"><a href="main-simu.html#cb46-82" tabindex="-1"></a>        }</span>
<span id="cb46-83"><a href="main-simu.html#cb46-83" tabindex="-1"></a>        newns <span class="ot">&lt;-</span> <span class="fu">fightbetterloss</span>(<span class="at">Ne=</span>Nts[i,], <span class="at">a=</span>s, <span class="at">b=</span>attack)</span>
<span id="cb46-84"><a href="main-simu.html#cb46-84" tabindex="-1"></a>        casualties <span class="ot">&lt;-</span> <span class="fu">sum</span>(Nts[i, <span class="fu">c</span>(s,attack)] <span class="sc">-</span> newns[<span class="fu">c</span>(s,attack)])</span>
<span id="cb46-85"><a href="main-simu.html#cb46-85" tabindex="-1"></a>        warcasualties[i] <span class="ot">&lt;-</span> casualties</span>
<span id="cb46-86"><a href="main-simu.html#cb46-86" tabindex="-1"></a>        sizew <span class="ot">&lt;-</span> casualties<span class="sc">^</span><span class="dv">2</span><span class="sc">/</span><span class="dv">4000</span></span>
<span id="cb46-87"><a href="main-simu.html#cb46-87" tabindex="-1"></a>        <span class="fu">warpoints</span>(sites, s, attack, <span class="at">Ne=</span>Nts[i,],</span>
<span id="cb46-88"><a href="main-simu.html#cb46-88" tabindex="-1"></a>                  <span class="at">buffersize=</span>buff, <span class="at">sizewar=</span>sizew<span class="fl">+0.5</span>)</span>
<span id="cb46-89"><a href="main-simu.html#cb46-89" tabindex="-1"></a>        </span>
<span id="cb46-90"><a href="main-simu.html#cb46-90" tabindex="-1"></a>        <span class="co">#effectively kill people in population (should be done taking into account age pyramid to be more realistic)</span></span>
<span id="cb46-91"><a href="main-simu.html#cb46-91" tabindex="-1"></a>        Ips[[s]] <span class="ot">&lt;-</span> <span class="fu">changePopSize</span>(<span class="at">loosingPop=</span>Ips[[s]],</span>
<span id="cb46-92"><a href="main-simu.html#cb46-92" tabindex="-1"></a>                                  <span class="at">size=</span>(Nts[i,s] <span class="sc">-</span> newns[s]))</span>
<span id="cb46-93"><a href="main-simu.html#cb46-93" tabindex="-1"></a>        Ips[[attack]] <span class="ot">&lt;-</span> <span class="fu">changePopSize</span>(<span class="at">loosingPop=</span>Ips[[attack]],</span>
<span id="cb46-94"><a href="main-simu.html#cb46-94" tabindex="-1"></a>                                       <span class="at">size=</span>(Nts[i, attack] <span class="sc">-</span> newns[attack]))</span>
<span id="cb46-95"><a href="main-simu.html#cb46-95" tabindex="-1"></a>        Nts[i,] <span class="ot">&lt;-</span> newns</span>
<span id="cb46-96"><a href="main-simu.html#cb46-96" tabindex="-1"></a>      }</span>
<span id="cb46-97"><a href="main-simu.html#cb46-97" tabindex="-1"></a>  }</span>
<span id="cb46-98"><a href="main-simu.html#cb46-98" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">Nts=</span>Nts, <span class="at">warcasualties=</span>warcasualties, <span class="at">Ips=</span>Ips, <span class="at">sites=</span>sites))</span>
<span id="cb46-99"><a href="main-simu.html#cb46-99" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<p>We wrapped all this in a function, <code>run_simulation</code> that return a list of object. Let see one simple example:</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="main-simu.html#cb47-1" tabindex="-1"></a>ts <span class="ot">&lt;-</span> <span class="dv">150</span> <span class="co"># we keep using 250 time steps.</span></span>
<span id="cb47-2"><a href="main-simu.html#cb47-2" tabindex="-1"></a>onesimu <span class="ot">&lt;-</span> <span class="fu">run_simulation</span>(</span>
<span id="cb47-3"><a href="main-simu.html#cb47-3" tabindex="-1"></a>  <span class="at">sites=</span>sites, <span class="at">viable=</span>viable, <span class="at">dem=</span>height.ras,</span>
<span id="cb47-4"><a href="main-simu.html#cb47-4" tabindex="-1"></a>  <span class="at">ressources=</span>ress,</span>
<span id="cb47-5"><a href="main-simu.html#cb47-5" tabindex="-1"></a>  <span class="at">water=</span>height.wat,</span>
<span id="cb47-6"><a href="main-simu.html#cb47-6" tabindex="-1"></a>  <span class="at">foldervid=</span><span class="cn">NULL</span>,</span>
<span id="cb47-7"><a href="main-simu.html#cb47-7" tabindex="-1"></a>  <span class="at">visu=</span>F, <span class="at">visumin=</span>T,</span>
<span id="cb47-8"><a href="main-simu.html#cb47-8" tabindex="-1"></a>  <span class="at">log=</span>F,</span>
<span id="cb47-9"><a href="main-simu.html#cb47-9" tabindex="-1"></a>  <span class="at">ts=</span>ts, <span class="co">#length of simulation in year</span></span>
<span id="cb47-10"><a href="main-simu.html#cb47-10" tabindex="-1"></a>  <span class="at">Kbase=</span><span class="fu">c</span>(<span class="st">&quot;HG&quot;</span><span class="ot">=</span><span class="dv">35</span>, <span class="st">&quot;F&quot;</span><span class="ot">=</span><span class="dv">110</span>), <span class="co">#difference in K for the two cultures</span></span>
<span id="cb47-11"><a href="main-simu.html#cb47-11" tabindex="-1"></a>  <span class="at">cul_ext=</span><span class="fu">c</span>(<span class="st">&quot;HG&quot;</span><span class="ot">=</span><span class="dv">7</span>, <span class="st">&quot;F&quot;</span><span class="ot">=</span><span class="dv">6</span>), <span class="co">#spatial penality to extent: lower, bigger penality</span></span>
<span id="cb47-12"><a href="main-simu.html#cb47-12" tabindex="-1"></a>  <span class="at">penal_cul=</span><span class="fu">c</span>(<span class="st">&quot;HG&quot;</span><span class="ot">=</span><span class="dv">4</span>, <span class="st">&quot;F&quot;</span><span class="ot">=</span><span class="dv">5</span>), <span class="co">#penality of occupational area: low, other sites can cam close</span></span>
<span id="cb47-13"><a href="main-simu.html#cb47-13" tabindex="-1"></a>  <span class="at">prob_birth=</span><span class="fu">c</span>(<span class="st">&quot;HG&quot;</span><span class="ot">=</span><span class="fl">0.4</span>, <span class="st">&quot;F&quot;</span><span class="ot">=</span><span class="fl">0.75</span>), <span class="co">#proba of giving birth every year</span></span>
<span id="cb47-14"><a href="main-simu.html#cb47-14" tabindex="-1"></a>  <span class="at">prob_survive=</span><span class="fu">c</span>(<span class="st">&quot;HG&quot;</span><span class="ot">=</span><span class="fl">0.8</span>, <span class="st">&quot;F&quot;</span><span class="ot">=</span><span class="fl">0.65</span>), <span class="co">#proba of dying when pop &gt; K</span></span>
<span id="cb47-15"><a href="main-simu.html#cb47-15" tabindex="-1"></a>  <span class="at">prob_split=</span><span class="fu">c</span>(<span class="st">&quot;HG&quot;</span><span class="ot">=</span><span class="fl">0.5</span>, <span class="st">&quot;F&quot;</span><span class="ot">=</span><span class="fl">0.6</span>), <span class="co">#proba of creating a new settlement when Ne &gt; K</span></span>
<span id="cb47-16"><a href="main-simu.html#cb47-16" tabindex="-1"></a>  <span class="at">minimals=</span><span class="fu">c</span>(<span class="st">&quot;HG&quot;</span><span class="ot">=</span><span class="fl">0.14</span>,<span class="st">&quot;F&quot;</span><span class="ot">=</span><span class="fl">0.20</span>), <span class="co">#how big the group of migrant should be to create a new city vs migrate to a existing one </span></span>
<span id="cb47-17"><a href="main-simu.html#cb47-17" tabindex="-1"></a>  <span class="at">probfight=</span><span class="fl">0.5</span>, <span class="co">#this has been added for the bookdown to increase conflict occurences ; it is of 0.1 in the original challenge, it allows to modulate the probability that any settlement in a position of conflict actually goes to war.</span></span>
<span id="cb47-18"><a href="main-simu.html#cb47-18" tabindex="-1"></a>  <span class="at">bufferatack=</span><span class="dv">1000</span>, <span class="co">#distance max around which settlement can fight </span></span>
<span id="cb47-19"><a href="main-simu.html#cb47-19" tabindex="-1"></a>  <span class="at">prob_move=</span><span class="fu">c</span>(<span class="st">&quot;HG&quot;</span><span class="ot">=</span><span class="fl">0.2</span>, <span class="st">&quot;F&quot;</span><span class="ot">=</span><span class="fl">0.1</span>) <span class="co">#proba of migrating to existing settlement when Ne &gt; K</span></span>
<span id="cb47-20"><a href="main-simu.html#cb47-20" tabindex="-1"></a>)</span></code></pre></div>
<div class="figure"><span style="display:block;" id="fig:single-run-ex1"></span>
<img src="_main_files/figure-html/single-run-ex1-.gif" alt="quick animation showing the simulation run in the previous chunk. Size o the dot represent the size of the settlement, the color its culture, where red represents farmers and blue hunter-gatherer. Flame represent fight between settlement, the size of the flame being proportional to the total number of casualties during the conflict (both sides included)." width="672" />
<p class="caption">
Figure 5.1: quick animation showing the simulation run in the previous chunk. Size o the dot represent the size of the settlement, the color its culture, where red represents farmers and blue hunter-gatherer. Flame represent fight between settlement, the size of the flame being proportional to the total number of casualties during the conflict (both sides included).
</p>
</div>
<p>Note that we here use a larger bufferatack that generates more conflicts and higher birth rates to make this simulation</p>
<p>To create your own video of the simulation you can replace <code>foldervid=NULL</code> by <code>foldervid=foldtmp</code> or any other folder you want. this will save all output in the folder you specify, and you can use the image to generate your video using, for exemple, <code>ffmpeg</code>.</p>
<p>We also save the different object generated by <code>run_simulation</code> to be able to re-load it, share it, analyse it, later.</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="main-simu.html#cb48-1" tabindex="-1"></a><span class="co">#write the terra SpatVect that stores all site sites location</span></span>
<span id="cb48-2"><a href="main-simu.html#cb48-2" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">writeVector</span>(onesimu<span class="sc">$</span>sites,<span class="fu">file.path</span>(foldtmp,<span class="st">&quot;allsites.shp&quot;</span>),<span class="at">overwrite=</span><span class="cn">TRUE</span>)</span>
<span id="cb48-3"><a href="main-simu.html#cb48-3" tabindex="-1"></a><span class="co">#write the matrix with all the population for all sites and all time steps</span></span>
<span id="cb48-4"><a href="main-simu.html#cb48-4" tabindex="-1"></a><span class="fu">saveRDS</span>(<span class="at">file=</span><span class="fu">file.path</span>(foldtmp,<span class="st">&quot;popSizeMatrix.RDS&quot;</span>),onesimu<span class="sc">$</span>Nts)</span>
<span id="cb48-5"><a href="main-simu.html#cb48-5" tabindex="-1"></a><span class="co">#write a list that stores  all the population structure for the sites at the end of the simulation</span></span>
<span id="cb48-6"><a href="main-simu.html#cb48-6" tabindex="-1"></a><span class="fu">saveRDS</span>(<span class="at">file=</span><span class="fu">file.path</span>(foldtmp,<span class="st">&quot;popStructList.RDS&quot;</span>),onesimu<span class="sc">$</span>Ips)</span>
<span id="cb48-7"><a href="main-simu.html#cb48-7" tabindex="-1"></a><span class="co">#write a vector that stores  the number of death due to conflict at each time step</span></span>
<span id="cb48-8"><a href="main-simu.html#cb48-8" tabindex="-1"></a><span class="fu">saveRDS</span>(<span class="at">file=</span><span class="fu">file.path</span>(foldtmp,<span class="st">&quot;wardeath.RDS&quot;</span>),onesimu<span class="sc">$</span>warcasualties)</span></code></pre></div>
<div id="source-code" class="section level3 unnumbered hasAnchor">
<h3>Source code<a href="main-simu.html#source-code" class="anchor-section" aria-label="Anchor link to header"></a></h3>
Check the code of the simulation functions here:
<details>
<summary>
Show code
</summary>
<p><strong>Code</strong></p>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="main-simu.html#cb49-1" tabindex="-1"></a><span class="do">## Function 17. Change population sizes</span></span>
<span id="cb49-2"><a href="main-simu.html#cb49-2" tabindex="-1"></a>changePopSize <span class="ot">&lt;-</span> <span class="cf">function</span>(loosingPop, size, <span class="at">winingPop=</span><span class="cn">NULL</span>, <span class="at">new=</span>F,</span>
<span id="cb49-3"><a href="main-simu.html#cb49-3" tabindex="-1"></a>                          <span class="at">method=</span><span class="st">&quot;random&quot;</span>, <span class="at">probs=</span>dnorm,</span>
<span id="cb49-4"><a href="main-simu.html#cb49-4" tabindex="-1"></a>                          <span class="at">prob.option=</span><span class="fu">list</span>(<span class="st">&quot;sd&quot;</span><span class="ot">=</span><span class="dv">10</span>, <span class="st">&quot;mean&quot;</span><span class="ot">=</span><span class="dv">22</span>)) {</span>
<span id="cb49-5"><a href="main-simu.html#cb49-5" tabindex="-1"></a>  <span class="co">#print(dim(loosingPop))</span></span>
<span id="cb49-6"><a href="main-simu.html#cb49-6" tabindex="-1"></a>  <span class="co">#if(!is.null(winingPop))</span></span>
<span id="cb49-7"><a href="main-simu.html#cb49-7" tabindex="-1"></a>  <span class="co">#    print(dim(winingPop))</span></span>
<span id="cb49-8"><a href="main-simu.html#cb49-8" tabindex="-1"></a>  <span class="co">#if(length(size)==0 || size==0)return(data.frame(Age=numeric(),Sex=character()))</span></span>
<span id="cb49-9"><a href="main-simu.html#cb49-9" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(loosingPop)<span class="sc">==</span><span class="dv">0</span>){</span>
<span id="cb49-10"><a href="main-simu.html#cb49-10" tabindex="-1"></a>    kill <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb49-11"><a href="main-simu.html#cb49-11" tabindex="-1"></a>  }<span class="cf">else</span> <span class="cf">if</span>(method<span class="sc">==</span><span class="st">&quot;random&quot;</span>){</span>
<span id="cb49-12"><a href="main-simu.html#cb49-12" tabindex="-1"></a>    kill <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(</span>
<span id="cb49-13"><a href="main-simu.html#cb49-13" tabindex="-1"></a>      <span class="fu">sample</span>(<span class="at">x=</span><span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(loosingPop), <span class="at">size=</span>size,</span>
<span id="cb49-14"><a href="main-simu.html#cb49-14" tabindex="-1"></a>             <span class="at">prob=</span><span class="fu">probs</span>(loosingPop<span class="sc">$</span>Age, <span class="at">mean=</span>prob.option<span class="sc">$</span>mean, <span class="at">sd=</span>prob.option<span class="sc">$</span>sd)),</span>
<span id="cb49-15"><a href="main-simu.html#cb49-15" tabindex="-1"></a>      <span class="at">error=</span><span class="cf">function</span>(e){</span>
<span id="cb49-16"><a href="main-simu.html#cb49-16" tabindex="-1"></a>        <span class="fu">print</span>(<span class="fu">paste0</span>(<span class="st">&quot;problem with population replacement for settlement of size:&quot;</span>,</span>
<span id="cb49-17"><a href="main-simu.html#cb49-17" tabindex="-1"></a>                     <span class="fu">nrow</span>(loosingPop), <span class="st">&quot; need to loose &quot;</span>, size));<span class="dv">0</span></span>
<span id="cb49-18"><a href="main-simu.html#cb49-18" tabindex="-1"></a>        }</span>
<span id="cb49-19"><a href="main-simu.html#cb49-19" tabindex="-1"></a>      )</span>
<span id="cb49-20"><a href="main-simu.html#cb49-20" tabindex="-1"></a>  }</span>
<span id="cb49-21"><a href="main-simu.html#cb49-21" tabindex="-1"></a>  <span class="co">#print(paste(&quot;diff&quot;,nrow(popdistrib)-size,&quot;new&quot;,size))</span></span>
<span id="cb49-22"><a href="main-simu.html#cb49-22" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(winingPop)){</span>
<span id="cb49-23"><a href="main-simu.html#cb49-23" tabindex="-1"></a>    winingPop <span class="ot">&lt;-</span> <span class="fu">rbind</span>(winingPop, loosingPop[kill,])</span>
<span id="cb49-24"><a href="main-simu.html#cb49-24" tabindex="-1"></a>  }</span>
<span id="cb49-25"><a href="main-simu.html#cb49-25" tabindex="-1"></a>  loosingPop <span class="ot">&lt;-</span> loosingPop[<span class="sc">-</span>kill,]</span>
<span id="cb49-26"><a href="main-simu.html#cb49-26" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(winingPop))</span>
<span id="cb49-27"><a href="main-simu.html#cb49-27" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(loosingPop, winingPop))</span>
<span id="cb49-28"><a href="main-simu.html#cb49-28" tabindex="-1"></a>  <span class="cf">else</span></span>
<span id="cb49-29"><a href="main-simu.html#cb49-29" tabindex="-1"></a>    <span class="fu">return</span>(loosingPop)</span>
<span id="cb49-30"><a href="main-simu.html#cb49-30" tabindex="-1"></a>  </span>
<span id="cb49-31"><a href="main-simu.html#cb49-31" tabindex="-1"></a>}</span>
<span id="cb49-32"><a href="main-simu.html#cb49-32" tabindex="-1"></a></span>
<span id="cb49-33"><a href="main-simu.html#cb49-33" tabindex="-1"></a></span>
<span id="cb49-34"><a href="main-simu.html#cb49-34" tabindex="-1"></a><span class="do">## Function 18. Check sites touching</span></span>
<span id="cb49-35"><a href="main-simu.html#cb49-35" tabindex="-1"></a>whotouch <span class="ot">&lt;-</span> <span class="cf">function</span>(i, sites, Ne, <span class="at">homophily=</span>F, <span class="at">buffersize=</span><span class="dv">200</span>){</span>
<span id="cb49-36"><a href="main-simu.html#cb49-36" tabindex="-1"></a>  touch <span class="ot">&lt;-</span> <span class="fu">st_intersects</span>(</span>
<span id="cb49-37"><a href="main-simu.html#cb49-37" tabindex="-1"></a>    <span class="fu">st_make_valid</span>(<span class="fu">st_as_sf</span>(<span class="fu">buffer</span>(sites[i], Ne[i] <span class="sc">*</span> buffersize<span class="fl">+0.00001</span>))),</span>
<span id="cb49-38"><a href="main-simu.html#cb49-38" tabindex="-1"></a>    <span class="fu">st_make_valid</span>(<span class="fu">st_as_sf</span>(<span class="fu">buffer</span>(sites, Ne <span class="sc">*</span> buffersize<span class="fl">+0.00001</span>))))</span>
<span id="cb49-39"><a href="main-simu.html#cb49-39" tabindex="-1"></a>  <span class="cf">if</span>( <span class="fu">length</span>(touch) <span class="sc">&gt;</span> <span class="dv">0</span> ){</span>
<span id="cb49-40"><a href="main-simu.html#cb49-40" tabindex="-1"></a>    enemies <span class="ot">&lt;-</span> <span class="fu">unlist</span>(touch)</span>
<span id="cb49-41"><a href="main-simu.html#cb49-41" tabindex="-1"></a>    <span class="cf">if</span>(homophily){</span>
<span id="cb49-42"><a href="main-simu.html#cb49-42" tabindex="-1"></a>      enemies <span class="ot">&lt;-</span> enemies[enemies <span class="sc">!=</span> i]</span>
<span id="cb49-43"><a href="main-simu.html#cb49-43" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb49-44"><a href="main-simu.html#cb49-44" tabindex="-1"></a>      enemies <span class="ot">&lt;-</span> enemies[sites<span class="sc">$</span>culture[enemies] <span class="sc">!=</span> sites<span class="sc">$</span>culture[i]]</span>
<span id="cb49-45"><a href="main-simu.html#cb49-45" tabindex="-1"></a>    }</span>
<span id="cb49-46"><a href="main-simu.html#cb49-46" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb49-47"><a href="main-simu.html#cb49-47" tabindex="-1"></a>    enemies <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb49-48"><a href="main-simu.html#cb49-48" tabindex="-1"></a>  }</span>
<span id="cb49-49"><a href="main-simu.html#cb49-49" tabindex="-1"></a>  <span class="co">#after adding a small number to zero, does that means that often some zero size group may be taken as fighter? checking below if this happen</span></span>
<span id="cb49-50"><a href="main-simu.html#cb49-50" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">sum</span>(Ne[enemies]<span class="sc">==</span><span class="dv">0</span>)<span class="sc">&gt;</span><span class="dv">0</span>){</span>
<span id="cb49-51"><a href="main-simu.html#cb49-51" tabindex="-1"></a>      <span class="fu">print</span>(<span class="st">&quot;some already dead enemies&quot;</span>)</span>
<span id="cb49-52"><a href="main-simu.html#cb49-52" tabindex="-1"></a>      <span class="fu">print</span>(<span class="fu">which</span>(Ne[enemies]<span class="sc">==</span><span class="dv">0</span>))</span>
<span id="cb49-53"><a href="main-simu.html#cb49-53" tabindex="-1"></a>      enemies<span class="ot">=</span>enemies[Ne[enemies]<span class="sc">&gt;</span><span class="dv">0</span>]</span>
<span id="cb49-54"><a href="main-simu.html#cb49-54" tabindex="-1"></a>  }</span>
<span id="cb49-55"><a href="main-simu.html#cb49-55" tabindex="-1"></a></span>
<span id="cb49-56"><a href="main-simu.html#cb49-56" tabindex="-1"></a>  <span class="fu">return</span>(enemies)</span>
<span id="cb49-57"><a href="main-simu.html#cb49-57" tabindex="-1"></a>}</span>
<span id="cb49-58"><a href="main-simu.html#cb49-58" tabindex="-1"></a></span>
<span id="cb49-59"><a href="main-simu.html#cb49-59" tabindex="-1"></a></span>
<span id="cb49-60"><a href="main-simu.html#cb49-60" tabindex="-1"></a><span class="do">## Function 19. Model a simple fight</span></span>
<span id="cb49-61"><a href="main-simu.html#cb49-61" tabindex="-1"></a>simplefight <span class="ot">&lt;-</span> <span class="cf">function</span>(Ne, a, b){</span>
<span id="cb49-62"><a href="main-simu.html#cb49-62" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">runif</span>(<span class="dv">1</span>) <span class="sc">&lt;</span> Ne[a] <span class="sc">/</span> (Ne[a] <span class="sc">+</span> Ne[b])){</span>
<span id="cb49-63"><a href="main-simu.html#cb49-63" tabindex="-1"></a>    v <span class="ot">&lt;-</span> a</span>
<span id="cb49-64"><a href="main-simu.html#cb49-64" tabindex="-1"></a>    l <span class="ot">&lt;-</span> b</span>
<span id="cb49-65"><a href="main-simu.html#cb49-65" tabindex="-1"></a>  }</span>
<span id="cb49-66"><a href="main-simu.html#cb49-66" tabindex="-1"></a>  <span class="cf">else</span>{</span>
<span id="cb49-67"><a href="main-simu.html#cb49-67" tabindex="-1"></a>    v <span class="ot">&lt;-</span> b</span>
<span id="cb49-68"><a href="main-simu.html#cb49-68" tabindex="-1"></a>    l <span class="ot">&lt;-</span> a</span>
<span id="cb49-69"><a href="main-simu.html#cb49-69" tabindex="-1"></a>  }</span>
<span id="cb49-70"><a href="main-simu.html#cb49-70" tabindex="-1"></a>  <span class="co"># Keep the original pop sizes for reporting outcome</span></span>
<span id="cb49-71"><a href="main-simu.html#cb49-71" tabindex="-1"></a>  one <span class="ot">&lt;-</span> Ne</span>
<span id="cb49-72"><a href="main-simu.html#cb49-72" tabindex="-1"></a>  <span class="co"># Update population sizes using a binomial</span></span>
<span id="cb49-73"><a href="main-simu.html#cb49-73" tabindex="-1"></a>  Ne[v] <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="at">n=</span><span class="dv">1</span>, <span class="at">prob=</span><span class="fl">0.9</span>, <span class="at">size=</span>Ne[v])</span>
<span id="cb49-74"><a href="main-simu.html#cb49-74" tabindex="-1"></a>  Ne[l] <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="at">n=</span><span class="dv">1</span>, <span class="at">prob=</span><span class="fl">0.4</span>, <span class="at">size=</span>Ne[l])</span>
<span id="cb49-75"><a href="main-simu.html#cb49-75" tabindex="-1"></a>  <span class="fu">print</span>(</span>
<span id="cb49-76"><a href="main-simu.html#cb49-76" tabindex="-1"></a>    <span class="fu">paste</span>(<span class="st">&quot;victory&quot;</span>, v, <span class="st">&quot;(&quot;</span>, one[v], <span class="st">&quot;-&quot;</span>, Ne[v],<span class="st">&quot;) over&quot;</span>, l, </span>
<span id="cb49-77"><a href="main-simu.html#cb49-77" tabindex="-1"></a>          <span class="st">&quot;(&quot;</span>,one[l],<span class="st">&quot;-&quot;</span>,Ne[l],<span class="st">&quot;), total of: &quot;</span>, (one[v]<span class="sc">-</span>Ne[v]) <span class="sc">+</span> (one[l]<span class="sc">-</span>Ne[l]), <span class="st">&quot;people&quot;</span>))</span>
<span id="cb49-78"><a href="main-simu.html#cb49-78" tabindex="-1"></a>  <span class="fu">return</span>(Ne)</span>
<span id="cb49-79"><a href="main-simu.html#cb49-79" tabindex="-1"></a>}   </span>
<span id="cb49-80"><a href="main-simu.html#cb49-80" tabindex="-1"></a></span>
<span id="cb49-81"><a href="main-simu.html#cb49-81" tabindex="-1"></a></span>
<span id="cb49-82"><a href="main-simu.html#cb49-82" tabindex="-1"></a><span class="do">## Function 20. Model fight with better probabilities</span></span>
<span id="cb49-83"><a href="main-simu.html#cb49-83" tabindex="-1"></a>fightbetterloss <span class="ot">&lt;-</span> <span class="cf">function</span>(Ne,a,b,<span class="at">log=</span>F){</span>
<span id="cb49-84"><a href="main-simu.html#cb49-84" tabindex="-1"></a>  <span class="cf">if</span>( <span class="fu">runif</span>(<span class="dv">1</span>) <span class="sc">&lt;</span> Ne[a]<span class="sc">/</span>(Ne[a] <span class="sc">+</span> Ne[b]) ){</span>
<span id="cb49-85"><a href="main-simu.html#cb49-85" tabindex="-1"></a>    v <span class="ot">&lt;-</span> a</span>
<span id="cb49-86"><a href="main-simu.html#cb49-86" tabindex="-1"></a>    l <span class="ot">&lt;-</span> b</span>
<span id="cb49-87"><a href="main-simu.html#cb49-87" tabindex="-1"></a>  }</span>
<span id="cb49-88"><a href="main-simu.html#cb49-88" tabindex="-1"></a>  <span class="cf">else</span>{</span>
<span id="cb49-89"><a href="main-simu.html#cb49-89" tabindex="-1"></a>    v <span class="ot">&lt;-</span> b</span>
<span id="cb49-90"><a href="main-simu.html#cb49-90" tabindex="-1"></a>    l <span class="ot">&lt;-</span> a</span>
<span id="cb49-91"><a href="main-simu.html#cb49-91" tabindex="-1"></a>  }</span>
<span id="cb49-92"><a href="main-simu.html#cb49-92" tabindex="-1"></a>  one <span class="ot">&lt;-</span> Ne</span>
<span id="cb49-93"><a href="main-simu.html#cb49-93" tabindex="-1"></a>  Ne[v] <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="at">n=</span><span class="dv">1</span>, <span class="at">prob=</span><span class="dv">1</span> <span class="sc">-</span> Ne[l]<span class="sc">/</span>(Ne[v] <span class="sc">+</span> Ne[l]), <span class="at">size=</span>Ne[v])</span>
<span id="cb49-94"><a href="main-simu.html#cb49-94" tabindex="-1"></a>  Ne[l] <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="at">n=</span><span class="dv">1</span>, <span class="at">prob=</span><span class="dv">1</span> <span class="sc">-</span> Ne[v]<span class="sc">/</span>(Ne[v] <span class="sc">+</span> Ne[l]), <span class="at">size=</span>Ne[l])</span>
<span id="cb49-95"><a href="main-simu.html#cb49-95" tabindex="-1"></a>  <span class="cf">if</span>(log)<span class="fu">print</span>(<span class="fu">paste0</span>(<span class="st">&quot;victory &quot;</span>, v, <span class="st">&quot;(&quot;</span>, one[v], <span class="st">&quot;-&quot;</span>, Ne[v],<span class="st">&quot;) over &quot;</span>, l,</span>
<span id="cb49-96"><a href="main-simu.html#cb49-96" tabindex="-1"></a>               <span class="st">&quot; (&quot;</span>, one[l], <span class="st">&quot;-&quot;</span>, Ne[l], <span class="st">&quot;), tot: &quot;</span>, (one[v]<span class="sc">-</span>Ne[v]) <span class="sc">+</span> (one[l]<span class="sc">-</span>Ne[l]), <span class="st">&quot;losses&quot;</span>))</span>
<span id="cb49-97"><a href="main-simu.html#cb49-97" tabindex="-1"></a>  <span class="fu">return</span>(Ne)</span>
<span id="cb49-98"><a href="main-simu.html#cb49-98" tabindex="-1"></a>}   </span>
<span id="cb49-99"><a href="main-simu.html#cb49-99" tabindex="-1"></a></span>
<span id="cb49-100"><a href="main-simu.html#cb49-100" tabindex="-1"></a></span>
<span id="cb49-101"><a href="main-simu.html#cb49-101" tabindex="-1"></a><span class="do">## Function 21. Draw a war symbol where two clans are fighting</span></span>
<span id="cb49-102"><a href="main-simu.html#cb49-102" tabindex="-1"></a>warpoints <span class="ot">&lt;-</span> <span class="cf">function</span>(sites, a, b, Ne, <span class="at">buffersize=</span><span class="dv">300</span>, <span class="at">plot=</span>T, <span class="at">sizewar=</span><span class="dv">2</span>){</span>
<span id="cb49-103"><a href="main-simu.html#cb49-103" tabindex="-1"></a>  meetpoints <span class="ot">&lt;-</span> <span class="fu">crop</span>(</span>
<span id="cb49-104"><a href="main-simu.html#cb49-104" tabindex="-1"></a>    <span class="fu">buffer</span>(sites[a], <span class="dv">1</span><span class="sc">+</span>Ne[a] <span class="sc">*</span> buffersize),</span>
<span id="cb49-105"><a href="main-simu.html#cb49-105" tabindex="-1"></a>    <span class="fu">buffer</span>(sites[b], <span class="dv">1</span><span class="sc">+</span>Ne[b] <span class="sc">*</span> buffersize)</span>
<span id="cb49-106"><a href="main-simu.html#cb49-106" tabindex="-1"></a>  )</span>
<span id="cb49-107"><a href="main-simu.html#cb49-107" tabindex="-1"></a>  <span class="cf">if</span>( <span class="fu">length</span>(meetpoints)<span class="sc">&gt;</span><span class="dv">0</span> ){</span>
<span id="cb49-108"><a href="main-simu.html#cb49-108" tabindex="-1"></a>    p <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">spatSample</span>(meetpoints, <span class="dv">1</span>)</span>
<span id="cb49-109"><a href="main-simu.html#cb49-109" tabindex="-1"></a>    <span class="cf">if</span>(plot <span class="sc">&amp;</span> <span class="fu">length</span>(p)<span class="sc">&gt;</span><span class="dv">0</span>){</span>
<span id="cb49-110"><a href="main-simu.html#cb49-110" tabindex="-1"></a>      <span class="fu">plot</span>(p, <span class="at">add=</span>T, <span class="at">bg=</span><span class="st">&quot;red&quot;</span>, <span class="at">pch=</span><span class="st">&quot;🔥&quot;</span>, <span class="at">cex=</span>sizewar<span class="sc">+</span><span class="dv">1</span>,</span>
<span id="cb49-111"><a href="main-simu.html#cb49-111" tabindex="-1"></a>           <span class="at">col=</span><span class="fu">adjustcolor</span>(<span class="st">&quot;yellow&quot;</span>, <span class="fl">0.1</span>))</span>
<span id="cb49-112"><a href="main-simu.html#cb49-112" tabindex="-1"></a>      <span class="fu">plot</span>(p, <span class="at">add=</span>T, <span class="at">bg=</span><span class="st">&quot;yellow&quot;</span>, <span class="at">pch=</span><span class="st">&quot;⚔️&quot;</span> ,<span class="at">cex=</span>sizewar)</span>
<span id="cb49-113"><a href="main-simu.html#cb49-113" tabindex="-1"></a>    }</span>
<span id="cb49-114"><a href="main-simu.html#cb49-114" tabindex="-1"></a>    <span class="fu">return</span>(p)</span>
<span id="cb49-115"><a href="main-simu.html#cb49-115" tabindex="-1"></a>  }</span>
<span id="cb49-116"><a href="main-simu.html#cb49-116" tabindex="-1"></a>  <span class="cf">else</span> <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb49-117"><a href="main-simu.html#cb49-117" tabindex="-1"></a>}</span>
<span id="cb49-118"><a href="main-simu.html#cb49-118" tabindex="-1"></a></span>
<span id="cb49-119"><a href="main-simu.html#cb49-119" tabindex="-1"></a></span>
<span id="cb49-120"><a href="main-simu.html#cb49-120" tabindex="-1"></a></span>
<span id="cb49-121"><a href="main-simu.html#cb49-121" tabindex="-1"></a><span class="do">## Function 22. Run simulation</span></span>
<span id="cb49-122"><a href="main-simu.html#cb49-122" tabindex="-1"></a>run_simulation <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">cultures=</span><span class="cn">NULL</span>,</span>
<span id="cb49-123"><a href="main-simu.html#cb49-123" tabindex="-1"></a>                           <span class="at">viable=</span><span class="cn">NULL</span>,</span>
<span id="cb49-124"><a href="main-simu.html#cb49-124" tabindex="-1"></a>                           <span class="at">sites=</span><span class="cn">NULL</span>,</span>
<span id="cb49-125"><a href="main-simu.html#cb49-125" tabindex="-1"></a>                           <span class="at">dem=</span><span class="cn">NULL</span>,</span>
<span id="cb49-126"><a href="main-simu.html#cb49-126" tabindex="-1"></a>                           <span class="at">ressources=</span><span class="cn">NULL</span>,</span>
<span id="cb49-127"><a href="main-simu.html#cb49-127" tabindex="-1"></a>                           <span class="at">water=</span><span class="cn">NULL</span>,</span>
<span id="cb49-128"><a href="main-simu.html#cb49-128" tabindex="-1"></a>                           <span class="at">foldervid=</span><span class="cn">NULL</span>,</span>
<span id="cb49-129"><a href="main-simu.html#cb49-129" tabindex="-1"></a>                           <span class="at">visu=</span><span class="cn">FALSE</span>,</span>
<span id="cb49-130"><a href="main-simu.html#cb49-130" tabindex="-1"></a>                           <span class="at">visumin=</span><span class="cn">TRUE</span>,</span>
<span id="cb49-131"><a href="main-simu.html#cb49-131" tabindex="-1"></a>                           <span class="at">probfight=</span><span class="fl">0.1</span>,</span>
<span id="cb49-132"><a href="main-simu.html#cb49-132" tabindex="-1"></a>                           <span class="at">log=</span>F,</span>
<span id="cb49-133"><a href="main-simu.html#cb49-133" tabindex="-1"></a>                           <span class="at">ts=</span><span class="dv">20000</span>,</span>
<span id="cb49-134"><a href="main-simu.html#cb49-134" tabindex="-1"></a>                           <span class="at">Kbase=</span><span class="fu">c</span>(<span class="st">&quot;HG&quot;</span><span class="ot">=</span><span class="dv">35</span>, <span class="st">&quot;F&quot;</span><span class="ot">=</span><span class="dv">120</span>),</span>
<span id="cb49-135"><a href="main-simu.html#cb49-135" tabindex="-1"></a>                           <span class="at">cul_ext=</span><span class="fu">c</span>(<span class="st">&quot;HG&quot;</span><span class="ot">=</span><span class="dv">7</span>, <span class="st">&quot;F&quot;</span><span class="ot">=</span><span class="dv">6</span>),</span>
<span id="cb49-136"><a href="main-simu.html#cb49-136" tabindex="-1"></a>                           <span class="at">penal_cul=</span><span class="fu">c</span>(<span class="st">&quot;HG&quot;</span><span class="ot">=</span><span class="dv">4</span>, <span class="st">&quot;F&quot;</span><span class="ot">=</span><span class="dv">5</span>),</span>
<span id="cb49-137"><a href="main-simu.html#cb49-137" tabindex="-1"></a>                           <span class="at">prob_birth=</span><span class="fu">c</span>(<span class="st">&quot;HG&quot;</span><span class="ot">=</span><span class="fl">0.3</span>, <span class="st">&quot;F&quot;</span><span class="ot">=</span><span class="fl">0.5</span>),</span>
<span id="cb49-138"><a href="main-simu.html#cb49-138" tabindex="-1"></a>                           <span class="at">prob_survive=</span><span class="fu">c</span>(<span class="st">&quot;HG&quot;</span><span class="ot">=</span><span class="fl">0.8</span>, <span class="st">&quot;F&quot;</span><span class="ot">=</span><span class="fl">0.6</span>),</span>
<span id="cb49-139"><a href="main-simu.html#cb49-139" tabindex="-1"></a>                           <span class="at">prob_split=</span><span class="fu">c</span>(<span class="st">&quot;HG&quot;</span><span class="ot">=</span> .<span class="dv">2</span>, <span class="st">&quot;F&quot;</span><span class="ot">=</span><span class="fl">0.6</span>),</span>
<span id="cb49-140"><a href="main-simu.html#cb49-140" tabindex="-1"></a>                           <span class="at">prob_move=</span><span class="fu">c</span>(<span class="st">&quot;HG&quot;</span><span class="ot">=</span><span class="fl">0.2</span>, <span class="st">&quot;F&quot;</span><span class="ot">=</span><span class="fl">0.1</span>),</span>
<span id="cb49-141"><a href="main-simu.html#cb49-141" tabindex="-1"></a>                           <span class="at">minimals=</span><span class="fu">c</span>(<span class="st">&quot;HG&quot;</span><span class="ot">=</span>.<span class="dv">14</span>, <span class="st">&quot;F&quot;</span><span class="ot">=</span>.<span class="dv">20</span>), </span>
<span id="cb49-142"><a href="main-simu.html#cb49-142" tabindex="-1"></a>                           <span class="at">bufferatack=</span><span class="dv">400</span>,</span>
<span id="cb49-143"><a href="main-simu.html#cb49-143" tabindex="-1"></a>                           <span class="at">buffersettl=</span><span class="dv">2000</span>,</span>
<span id="cb49-144"><a href="main-simu.html#cb49-144" tabindex="-1"></a>                           <span class="at">Nts=</span><span class="cn">NULL</span>,</span>
<span id="cb49-145"><a href="main-simu.html#cb49-145" tabindex="-1"></a>                           <span class="at">Ips=</span><span class="cn">NULL</span></span>
<span id="cb49-146"><a href="main-simu.html#cb49-146" tabindex="-1"></a>){</span>
<span id="cb49-147"><a href="main-simu.html#cb49-147" tabindex="-1"></a>  <span class="do">## Run stochastic process  </span></span>
<span id="cb49-148"><a href="main-simu.html#cb49-148" tabindex="-1"></a>  wplot <span class="ot">&lt;-</span> F</span>
<span id="cb49-149"><a href="main-simu.html#cb49-149" tabindex="-1"></a>  <span class="cf">if</span>(visumin <span class="sc">||</span> visu) wplot <span class="ot">&lt;-</span> T</span>
<span id="cb49-150"><a href="main-simu.html#cb49-150" tabindex="-1"></a>  Ks <span class="ot">&lt;-</span> sites<span class="sc">$</span>Ks</span>
<span id="cb49-151"><a href="main-simu.html#cb49-151" tabindex="-1"></a>  cultures <span class="ot">&lt;-</span> sites<span class="sc">$</span>culture</span>
<span id="cb49-152"><a href="main-simu.html#cb49-152" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(Nts)){ </span>
<span id="cb49-153"><a href="main-simu.html#cb49-153" tabindex="-1"></a>    INs <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">runif</span>(<span class="fu">length</span>(sites), <span class="fl">0.85</span>, <span class="fl">0.95</span>) <span class="sc">*</span> sites<span class="sc">$</span>Ks) <span class="co">#Population size at initialisation</span></span>
<span id="cb49-154"><a href="main-simu.html#cb49-154" tabindex="-1"></a>    Ips <span class="ot">&lt;-</span> <span class="fu">lapply</span>(INs, initpopstruc) <span class="co">#initialise population structure for all sites</span></span>
<span id="cb49-155"><a href="main-simu.html#cb49-155" tabindex="-1"></a>    Nts <span class="ot">&lt;-</span> <span class="fu">initlistsites</span>(Ips, <span class="at">ts=</span>ts)</span>
<span id="cb49-156"><a href="main-simu.html#cb49-156" tabindex="-1"></a>    frame <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb49-157"><a href="main-simu.html#cb49-157" tabindex="-1"></a>    mint <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb49-158"><a href="main-simu.html#cb49-158" tabindex="-1"></a>  } <span class="cf">else</span> {<span class="do">##should check and test howto start back a simulation</span></span>
<span id="cb49-159"><a href="main-simu.html#cb49-159" tabindex="-1"></a>    mint <span class="ot">&lt;-</span> <span class="fu">nrow</span>(Nts) </span>
<span id="cb49-160"><a href="main-simu.html#cb49-160" tabindex="-1"></a>    frame <span class="ot">&lt;-</span> <span class="fu">nrow</span>(Nts) </span>
<span id="cb49-161"><a href="main-simu.html#cb49-161" tabindex="-1"></a>  }</span>
<span id="cb49-162"><a href="main-simu.html#cb49-162" tabindex="-1"></a>  </span>
<span id="cb49-163"><a href="main-simu.html#cb49-163" tabindex="-1"></a>  <span class="do">### visualisation =====</span></span>
<span id="cb49-164"><a href="main-simu.html#cb49-164" tabindex="-1"></a>  <span class="cf">if</span>(visu <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">is.null</span>(foldervid) <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">dir.exists</span>(foldervid))</span>
<span id="cb49-165"><a href="main-simu.html#cb49-165" tabindex="-1"></a>    <span class="fu">dir.create</span>(foldervid)</span>
<span id="cb49-166"><a href="main-simu.html#cb49-166" tabindex="-1"></a>  <span class="do">###</span></span>
<span id="cb49-167"><a href="main-simu.html#cb49-167" tabindex="-1"></a>  </span>
<span id="cb49-168"><a href="main-simu.html#cb49-168" tabindex="-1"></a>  warcasualties <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">&quot;integer&quot;</span>, ts)</span>
<span id="cb49-169"><a href="main-simu.html#cb49-169" tabindex="-1"></a>  </span>
<span id="cb49-170"><a href="main-simu.html#cb49-170" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>(ts<span class="sc">+</span><span class="dv">1</span>)){</span>
<span id="cb49-171"><a href="main-simu.html#cb49-171" tabindex="-1"></a>    countcult <span class="ot">&lt;-</span> <span class="fu">table</span>(sites<span class="sc">$</span>culture[Nts[i<span class="dv">-1</span>, ] <span class="sc">&gt;</span> <span class="dv">0</span>])</span>
<span id="cb49-172"><a href="main-simu.html#cb49-172" tabindex="-1"></a>    <span class="cf">if</span> ( <span class="fu">length</span>(countcult) <span class="sc">!=</span> <span class="dv">2</span> ) {</span>
<span id="cb49-173"><a href="main-simu.html#cb49-173" tabindex="-1"></a>      <span class="fu">return</span>(</span>
<span id="cb49-174"><a href="main-simu.html#cb49-174" tabindex="-1"></a>        <span class="fu">list</span>(<span class="at">Nts=</span>Nts[,<span class="dv">1</span><span class="sc">:</span>i], </span>
<span id="cb49-175"><a href="main-simu.html#cb49-175" tabindex="-1"></a>             <span class="at">warcasualties=</span>warcasualties[<span class="dv">1</span><span class="sc">:</span>i],</span>
<span id="cb49-176"><a href="main-simu.html#cb49-176" tabindex="-1"></a>             <span class="at">Ips=</span>Ips,</span>
<span id="cb49-177"><a href="main-simu.html#cb49-177" tabindex="-1"></a>             <span class="at">sites=</span>sites</span>
<span id="cb49-178"><a href="main-simu.html#cb49-178" tabindex="-1"></a>        )</span>
<span id="cb49-179"><a href="main-simu.html#cb49-179" tabindex="-1"></a>      )</span>
<span id="cb49-180"><a href="main-simu.html#cb49-180" tabindex="-1"></a>    }</span>
<span id="cb49-181"><a href="main-simu.html#cb49-181" tabindex="-1"></a>    <span class="cf">if</span>(log){</span>
<span id="cb49-182"><a href="main-simu.html#cb49-182" tabindex="-1"></a>        <span class="fu">print</span>(</span>
<span id="cb49-183"><a href="main-simu.html#cb49-183" tabindex="-1"></a>              <span class="fu">paste</span>(<span class="st">&quot;year&quot;</span>, i, <span class="st">&quot;total&quot;</span>, <span class="fu">sum</span>(<span class="fu">sapply</span>(Ips,nrow)),</span>
<span id="cb49-184"><a href="main-simu.html#cb49-184" tabindex="-1"></a>                    <span class="st">&quot;with&quot;</span>, <span class="fu">length</span>(sites), <span class="st">&quot;sites (&quot;</span>, </span>
<span id="cb49-185"><a href="main-simu.html#cb49-185" tabindex="-1"></a>                    <span class="fu">paste0</span>(<span class="fu">paste</span>(<span class="fu">names</span>(countcult), countcult, <span class="at">sep=</span><span class="st">&quot;:&quot;</span>), <span class="at">collapse=</span><span class="st">&quot;,&quot;</span>), <span class="st">&quot;)&quot;</span>))</span>
<span id="cb49-186"><a href="main-simu.html#cb49-186" tabindex="-1"></a>      }</span>
<span id="cb49-187"><a href="main-simu.html#cb49-187" tabindex="-1"></a>    <span class="cf">if</span> (visumin){</span>
<span id="cb49-188"><a href="main-simu.html#cb49-188" tabindex="-1"></a>      <span class="do">### visualisation =====</span></span>
<span id="cb49-189"><a href="main-simu.html#cb49-189" tabindex="-1"></a>      frame <span class="ot">&lt;-</span> frame<span class="sc">+</span><span class="dv">1</span></span>
<span id="cb49-190"><a href="main-simu.html#cb49-190" tabindex="-1"></a>      <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(foldervid)){</span>
<span id="cb49-191"><a href="main-simu.html#cb49-191" tabindex="-1"></a>          filename <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(<span class="st">&quot;map_%06d.png&quot;</span>, frame)</span>
<span id="cb49-192"><a href="main-simu.html#cb49-192" tabindex="-1"></a>          <span class="fu">png</span>(<span class="fu">file.path</span>(foldervid,filename), <span class="at">width=</span><span class="dv">800</span>, <span class="at">height=</span><span class="dv">800</span>, <span class="at">pointsize=</span><span class="dv">20</span>)</span>
<span id="cb49-193"><a href="main-simu.html#cb49-193" tabindex="-1"></a>      }</span>
<span id="cb49-194"><a href="main-simu.html#cb49-194" tabindex="-1"></a>      <span class="fu">plotMap</span>(dem, water, <span class="fu">paste0</span>(<span class="st">&quot;year &quot;</span>,i))</span>
<span id="cb49-195"><a href="main-simu.html#cb49-195" tabindex="-1"></a>      <span class="do">########</span></span>
<span id="cb49-196"><a href="main-simu.html#cb49-196" tabindex="-1"></a>    }</span>
<span id="cb49-197"><a href="main-simu.html#cb49-197" tabindex="-1"></a>    inactives <span class="ot">&lt;-</span> (Nts[i<span class="dv">-1</span>,]<span class="sc">==</span><span class="dv">0</span>)</span>
<span id="cb49-198"><a href="main-simu.html#cb49-198" tabindex="-1"></a>    <span class="cf">for</span> ( s <span class="cf">in</span> <span class="fu">sample</span>(<span class="fu">seq_along</span>(sites)[<span class="sc">!</span>inactives]) ){</span>
<span id="cb49-199"><a href="main-simu.html#cb49-199" tabindex="-1"></a>      <span class="cf">if</span> ( visu ) {</span>
<span id="cb49-200"><a href="main-simu.html#cb49-200" tabindex="-1"></a>        <span class="do">### visualisation =====</span></span>
<span id="cb49-201"><a href="main-simu.html#cb49-201" tabindex="-1"></a>        frame <span class="ot">&lt;-</span> frame<span class="sc">+</span><span class="dv">1</span></span>
<span id="cb49-202"><a href="main-simu.html#cb49-202" tabindex="-1"></a>        filename <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(<span class="st">&quot;map_%08d.png&quot;</span>, frame)</span>
<span id="cb49-203"><a href="main-simu.html#cb49-203" tabindex="-1"></a>        <span class="fu">png</span>(<span class="fu">file.path</span>(foldervid,filename), <span class="at">width=</span><span class="dv">800</span>, <span class="at">height=</span><span class="dv">800</span>, <span class="at">pointsize=</span><span class="dv">20</span>)</span>
<span id="cb49-204"><a href="main-simu.html#cb49-204" tabindex="-1"></a>        <span class="fu">plotMap</span>(dem,water,<span class="fu">paste0</span>(<span class="st">&quot;year &quot;</span>, i))</span>
<span id="cb49-205"><a href="main-simu.html#cb49-205" tabindex="-1"></a>        <span class="do">########</span></span>
<span id="cb49-206"><a href="main-simu.html#cb49-206" tabindex="-1"></a>      }</span>
<span id="cb49-207"><a href="main-simu.html#cb49-207" tabindex="-1"></a>      </span>
<span id="cb49-208"><a href="main-simu.html#cb49-208" tabindex="-1"></a>      city <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb49-209"><a href="main-simu.html#cb49-209" tabindex="-1"></a>      Ips[[s]] <span class="ot">&lt;-</span> <span class="fu">Gpd</span>( <span class="co">#compute new population for the sites</span></span>
<span id="cb49-210"><a href="main-simu.html#cb49-210" tabindex="-1"></a>        Ips[[s]], <span class="at">K =</span> Ks[[s]],</span>
<span id="cb49-211"><a href="main-simu.html#cb49-211" tabindex="-1"></a>        <span class="at">p_offspring =</span> prob_birth[sites<span class="sc">$</span>culture[s]],</span>
<span id="cb49-212"><a href="main-simu.html#cb49-212" tabindex="-1"></a>        <span class="at">prob =</span> prob_survive[sites<span class="sc">$</span>culture[s]]</span>
<span id="cb49-213"><a href="main-simu.html#cb49-213" tabindex="-1"></a>      )</span>
<span id="cb49-214"><a href="main-simu.html#cb49-214" tabindex="-1"></a>      newN <span class="ot">&lt;-</span> <span class="fu">nrow</span>(Ips[[s]]) <span class="co">#count population size</span></span>
<span id="cb49-215"><a href="main-simu.html#cb49-215" tabindex="-1"></a>      </span>
<span id="cb49-216"><a href="main-simu.html#cb49-216" tabindex="-1"></a>      <span class="cf">if</span>(newN <span class="sc">&gt;=</span> (Ks[[s]])){ <span class="co">#if new population is more than carrying capacity: migration scenario</span></span>
<span id="cb49-217"><a href="main-simu.html#cb49-217" tabindex="-1"></a>        migrants <span class="ot">&lt;-</span> newN <span class="sc">-</span> <span class="fu">round</span>(Ks[[s]]<span class="sc">*</span><span class="fl">0.9</span>)</span>
<span id="cb49-218"><a href="main-simu.html#cb49-218" tabindex="-1"></a>        <span class="do">##Creation of new city</span></span>
<span id="cb49-219"><a href="main-simu.html#cb49-219" tabindex="-1"></a>        new_site <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb49-220"><a href="main-simu.html#cb49-220" tabindex="-1"></a>        <span class="co">#if(sites$culture[s]==&quot;F&quot;)print(paste(&quot;possib&quot;,migrants, (minimals[sites$culture[s]]*sites$Ks[s])))</span></span>
<span id="cb49-221"><a href="main-simu.html#cb49-221" tabindex="-1"></a>        tmp <span class="ot">&lt;-</span> Nts[i<span class="dv">-1</span>,]</span>
<span id="cb49-222"><a href="main-simu.html#cb49-222" tabindex="-1"></a>        tmp[Nts[i,] <span class="sc">&gt;</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> Nts[i, Nts[i,] <span class="sc">&gt;</span> <span class="dv">0</span>]</span>
<span id="cb49-223"><a href="main-simu.html#cb49-223" tabindex="-1"></a>        <span class="co">#tmp=tmp+sqrt(sites$Ks)</span></span>
<span id="cb49-224"><a href="main-simu.html#cb49-224" tabindex="-1"></a>        havemoved <span class="ot">&lt;-</span> F</span>
<span id="cb49-225"><a href="main-simu.html#cb49-225" tabindex="-1"></a>        </span>
<span id="cb49-226"><a href="main-simu.html#cb49-226" tabindex="-1"></a>        <span class="cf">if</span> (migrants <span class="sc">&gt;=</span> (minimals[sites<span class="sc">$</span>culture[s]]<span class="sc">*</span>sites<span class="sc">$</span>Ks[s]) <span class="sc">&amp;</span> <span class="fu">runif</span>(<span class="dv">1</span>)<span class="sc">&lt;</span>prob_split[sites<span class="sc">$</span>culture[s]] ){</span>
<span id="cb49-227"><a href="main-simu.html#cb49-227" tabindex="-1"></a>          <span class="co">#if supopulation &gt; 10 people, 10% chance of creation of a new city</span></span>
<span id="cb49-228"><a href="main-simu.html#cb49-228" tabindex="-1"></a>          </span>
<span id="cb49-229"><a href="main-simu.html#cb49-229" tabindex="-1"></a>          <span class="co">#print(paste(&quot;look for new spot for &quot;,migrants, &quot;from site&quot;,s,&quot;culture&quot;,sites$culture[s]))</span></span>
<span id="cb49-230"><a href="main-simu.html#cb49-230" tabindex="-1"></a>          <span class="co">#mean of area of influence</span></span>
<span id="cb49-231"><a href="main-simu.html#cb49-231" tabindex="-1"></a>          infarea <span class="ot">&lt;-</span> (<span class="fu">sqrt</span>(tmp)<span class="sc">+</span>penal_cul[cultures]) <span class="sc">*</span> buffersettl</span>
<span id="cb49-232"><a href="main-simu.html#cb49-232" tabindex="-1"></a>          buffersize <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="fu">length</span>(infarea), infarea, infarea <span class="sc">*</span> <span class="fl">0.1</span>)</span>
<span id="cb49-233"><a href="main-simu.html#cb49-233" tabindex="-1"></a>          buffersize[tmp<span class="sc">==</span><span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="fl">0.00001</span></span>
<span id="cb49-234"><a href="main-simu.html#cb49-234" tabindex="-1"></a>          territory <span class="ot">&lt;-</span> <span class="fu">erase</span>(viable, <span class="fu">buffer</span>(sites, buffersize))</span>
<span id="cb49-235"><a href="main-simu.html#cb49-235" tabindex="-1"></a>          </span>
<span id="cb49-236"><a href="main-simu.html#cb49-236" tabindex="-1"></a>          <span class="cf">if</span>( <span class="fu">length</span>(territory)<span class="sc">&gt;</span><span class="dv">0</span> ){</span>
<span id="cb49-237"><a href="main-simu.html#cb49-237" tabindex="-1"></a>            <span class="co">#print(paste(&quot;found new spot&quot;,migrants))</span></span>
<span id="cb49-238"><a href="main-simu.html#cb49-238" tabindex="-1"></a>            </span>
<span id="cb49-239"><a href="main-simu.html#cb49-239" tabindex="-1"></a>            <span class="do">##select a new site given its distance to the old one and the ressourcesource available in ressources</span></span>
<span id="cb49-240"><a href="main-simu.html#cb49-240" tabindex="-1"></a>            d2 <span class="ot">&lt;-</span> <span class="fu">logisticdecay</span>(</span>
<span id="cb49-241"><a href="main-simu.html#cb49-241" tabindex="-1"></a>              sites[s], dem, <span class="at">x=</span><span class="dv">20000</span><span class="sc">*</span>cul_ext[sites<span class="sc">$</span>culture[s]]</span>
<span id="cb49-242"><a href="main-simu.html#cb49-242" tabindex="-1"></a>            )</span>
<span id="cb49-243"><a href="main-simu.html#cb49-243" tabindex="-1"></a>            w <span class="ot">&lt;-</span> (<span class="fl">0.7</span> <span class="sc">*</span> d2 <span class="sc">+</span> <span class="fl">0.3</span><span class="sc">*</span>ressources) <span class="sc">/</span> (<span class="fl">0.7</span><span class="sc">*</span><span class="fu">minmax</span>(d2)[<span class="dv">2</span>] <span class="sc">+</span> <span class="fl">0.3</span><span class="sc">*</span><span class="fu">minmax</span>(ressources)[<span class="dv">2</span>])</span>
<span id="cb49-244"><a href="main-simu.html#cb49-244" tabindex="-1"></a>            new_site <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">spatSample</span>(</span>
<span id="cb49-245"><a href="main-simu.html#cb49-245" tabindex="-1"></a>              <span class="at">x=</span><span class="fu">mask</span>(</span>
<span id="cb49-246"><a href="main-simu.html#cb49-246" tabindex="-1"></a>                w <span class="sc">*</span> <span class="fu">logisticdecay</span>(sites[s], dem, <span class="at">k=</span><span class="fl">0.00002</span>,</span>
<span id="cb49-247"><a href="main-simu.html#cb49-247" tabindex="-1"></a>                                  <span class="at">x=</span><span class="dv">20000</span><span class="sc">*</span>cul_ext[sites<span class="sc">$</span>culture[s]]),</span>
<span id="cb49-248"><a href="main-simu.html#cb49-248" tabindex="-1"></a>                territory),</span>
<span id="cb49-249"><a href="main-simu.html#cb49-249" tabindex="-1"></a>              <span class="at">size=</span><span class="dv">1</span>, <span class="at">method=</span><span class="st">&quot;weights&quot;</span>, <span class="at">xy=</span>T)[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]</span>
<span id="cb49-250"><a href="main-simu.html#cb49-250" tabindex="-1"></a>            new_site <span class="ot">&lt;-</span> <span class="fu">vect</span>(new_site, <span class="at">geom=</span><span class="fu">c</span>(<span class="st">&quot;x&quot;</span>,<span class="st">&quot;y&quot;</span>))</span>
<span id="cb49-251"><a href="main-simu.html#cb49-251" tabindex="-1"></a>            </span>
<span id="cb49-252"><a href="main-simu.html#cb49-252" tabindex="-1"></a>            <span class="cf">if</span> ( <span class="fu">length</span>(new_site)<span class="sc">&gt;</span><span class="dv">0</span> <span class="sc">&amp;</span> <span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(<span class="fu">crds</span>(new_site))) ){</span>
<span id="cb49-253"><a href="main-simu.html#cb49-253" tabindex="-1"></a>              <span class="do">##add new site to site listes</span></span>
<span id="cb49-254"><a href="main-simu.html#cb49-254" tabindex="-1"></a>              <span class="do">##initialise population struc of new site</span></span>
<span id="cb49-255"><a href="main-simu.html#cb49-255" tabindex="-1"></a>              <span class="co">#print(paste(&quot;total sites:&quot;,length(Ips)))</span></span>
<span id="cb49-256"><a href="main-simu.html#cb49-256" tabindex="-1"></a>              <span class="co">#print(paste(&quot;dim Nts:&quot;,dim(Nts)[2]))</span></span>
<span id="cb49-257"><a href="main-simu.html#cb49-257" tabindex="-1"></a>              <span class="co">#print(paste(&quot;site sf Nts:&quot;,length(sites)))</span></span>
<span id="cb49-258"><a href="main-simu.html#cb49-258" tabindex="-1"></a>              </span>
<span id="cb49-259"><a href="main-simu.html#cb49-259" tabindex="-1"></a>              Ips[[<span class="fu">length</span>(Ips)<span class="sc">+</span><span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fu">initpopstruc</span>(<span class="at">n=</span>migrants) <span class="co">#initialise a fake populaition, will be updated by real migrants later</span></span>
<span id="cb49-260"><a href="main-simu.html#cb49-260" tabindex="-1"></a>              new_site<span class="sc">$</span>culture <span class="ot">&lt;-</span> sites<span class="sc">$</span>culture[s]</span>
<span id="cb49-261"><a href="main-simu.html#cb49-261" tabindex="-1"></a>              new_site<span class="sc">$</span>Ks <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">initKs</span>(</span>
<span id="cb49-262"><a href="main-simu.html#cb49-262" tabindex="-1"></a>                Kbase, <span class="at">sites=</span>new_site, ressources,</span>
<span id="cb49-263"><a href="main-simu.html#cb49-263" tabindex="-1"></a>                <span class="at">sizeex=</span><span class="st">&quot;F&quot;</span>, <span class="at">rate=</span><span class="fl">0.45</span>))</span>
<span id="cb49-264"><a href="main-simu.html#cb49-264" tabindex="-1"></a>              <span class="cf">if</span>(log){</span>
<span id="cb49-265"><a href="main-simu.html#cb49-265" tabindex="-1"></a>                  <span class="fu">print</span>(<span class="fu">paste0</span>(<span class="st">&quot;new settlement (&quot;</span>, sites<span class="sc">$</span>culture[s], <span class="st">&quot;) of K &quot;</span>,</span>
<span id="cb49-266"><a href="main-simu.html#cb49-266" tabindex="-1"></a>                           new_site<span class="sc">$</span>Ks, <span class="st">&quot; and pop &quot;</span>, migrants))</span>
<span id="cb49-267"><a href="main-simu.html#cb49-267" tabindex="-1"></a>              }</span>
<span id="cb49-268"><a href="main-simu.html#cb49-268" tabindex="-1"></a>              </span>
<span id="cb49-269"><a href="main-simu.html#cb49-269" tabindex="-1"></a>              sites <span class="ot">&lt;-</span> <span class="fu">rbind</span>(sites, new_site)</span>
<span id="cb49-270"><a href="main-simu.html#cb49-270" tabindex="-1"></a>              </span>
<span id="cb49-271"><a href="main-simu.html#cb49-271" tabindex="-1"></a>              Ks[<span class="fu">length</span>(Ks)<span class="sc">+</span><span class="dv">1</span>] <span class="ot">&lt;-</span> new_site<span class="sc">$</span>Ks</span>
<span id="cb49-272"><a href="main-simu.html#cb49-272" tabindex="-1"></a>              city <span class="ot">&lt;-</span> <span class="fu">length</span>(Ips)</span>
<span id="cb49-273"><a href="main-simu.html#cb49-273" tabindex="-1"></a>              Nts <span class="ot">&lt;-</span> <span class="fu">cbind</span>(Nts, <span class="fu">rep</span>(<span class="dv">0</span>,ts<span class="sc">+</span><span class="dv">1</span>))</span>
<span id="cb49-274"><a href="main-simu.html#cb49-274" tabindex="-1"></a>              Nts[i, city] <span class="ot">&lt;-</span> migrants</span>
<span id="cb49-275"><a href="main-simu.html#cb49-275" tabindex="-1"></a>              cultures <span class="ot">&lt;-</span> <span class="fu">c</span>(cultures, cultures[s])</span>
<span id="cb49-276"><a href="main-simu.html#cb49-276" tabindex="-1"></a>              <span class="co">#print(paste(&quot;new site sf Nts:&quot;,length(sites)))</span></span>
<span id="cb49-277"><a href="main-simu.html#cb49-277" tabindex="-1"></a>              <span class="co">#print(paste(&quot;new dim Nts:&quot;,dim(Nts)[2]))</span></span>
<span id="cb49-278"><a href="main-simu.html#cb49-278" tabindex="-1"></a>              <span class="co">#print(paste(&quot;new total sites:&quot;,length(Ips)))</span></span>
<span id="cb49-279"><a href="main-simu.html#cb49-279" tabindex="-1"></a>              havemoved <span class="ot">&lt;-</span> T</span>
<span id="cb49-280"><a href="main-simu.html#cb49-280" tabindex="-1"></a>            }</span>
<span id="cb49-281"><a href="main-simu.html#cb49-281" tabindex="-1"></a>          }</span>
<span id="cb49-282"><a href="main-simu.html#cb49-282" tabindex="-1"></a>        }</span>
<span id="cb49-283"><a href="main-simu.html#cb49-283" tabindex="-1"></a>        <span class="do">## if no creation of new city happen, there is a certain probability that people will move</span></span>
<span id="cb49-284"><a href="main-simu.html#cb49-284" tabindex="-1"></a>        <span class="cf">if</span>( <span class="fu">length</span>(new_site)<span class="sc">==</span><span class="dv">0</span> <span class="sc">&amp;&amp;</span> <span class="fu">runif</span>(<span class="dv">1</span>) <span class="sc">&lt;</span> prob_move[sites<span class="sc">$</span>culture[s]] ){</span>
<span id="cb49-285"><a href="main-simu.html#cb49-285" tabindex="-1"></a>          </span>
<span id="cb49-286"><a href="main-simu.html#cb49-286" tabindex="-1"></a>          <span class="co">#getj</span></span>
<span id="cb49-287"><a href="main-simu.html#cb49-287" tabindex="-1"></a>          att <span class="ot">&lt;-</span> <span class="fu">extract</span>(ressources,sites)[,<span class="dv">2</span>]</span>
<span id="cb49-288"><a href="main-simu.html#cb49-288" tabindex="-1"></a>          space <span class="ot">&lt;-</span> sites<span class="sc">$</span>Ks <span class="sc">-</span> (Nts[i<span class="dv">-1</span>,] <span class="sc">+</span> migrants)</span>
<span id="cb49-289"><a href="main-simu.html#cb49-289" tabindex="-1"></a>          dis <span class="ot">&lt;-</span> <span class="fu">extract</span>(<span class="fu">logisticdecay</span>(sites[s], dem, <span class="at">k=</span><span class="fl">0.00002</span>, <span class="at">x=</span><span class="dv">1</span>), sites)[,<span class="dv">2</span>]</span>
<span id="cb49-290"><a href="main-simu.html#cb49-290" tabindex="-1"></a>          attractivity <span class="ot">&lt;-</span> att <span class="sc">*</span> space <span class="sc">*</span> dis</span>
<span id="cb49-291"><a href="main-simu.html#cb49-291" tabindex="-1"></a>          <span class="co">#attractivity=attractivity*(1+10*(sites$culture[s]==sites$culture)) #4 times more likely to go to similar culture</span></span>
<span id="cb49-292"><a href="main-simu.html#cb49-292" tabindex="-1"></a>          attractivity[s] <span class="ot">&lt;-</span> <span class="fu">min</span>(attractivity)<span class="sc">-</span><span class="dv">1</span></span>
<span id="cb49-293"><a href="main-simu.html#cb49-293" tabindex="-1"></a>          attractivity <span class="ot">&lt;-</span> <span class="fu">exp</span>(attractivity)<span class="sc">/</span><span class="fu">sum</span>(<span class="fu">exp</span>(attractivity))</span>
<span id="cb49-294"><a href="main-simu.html#cb49-294" tabindex="-1"></a>          attractivity[Nts[i<span class="dv">-1</span>,]<span class="sc">&lt;</span><span class="dv">10</span>] <span class="ot">&lt;-</span> <span class="dv">0</span> </span>
<span id="cb49-295"><a href="main-simu.html#cb49-295" tabindex="-1"></a>          attractivity[sites<span class="sc">$</span>culture<span class="sc">!=</span>sites<span class="sc">$</span>culture[s]] <span class="ot">&lt;-</span> <span class="dv">0</span> </span>
<span id="cb49-296"><a href="main-simu.html#cb49-296" tabindex="-1"></a>          <span class="cf">if</span>(<span class="fu">any</span>(<span class="fu">is.na</span>(attractivity))){</span>
<span id="cb49-297"><a href="main-simu.html#cb49-297" tabindex="-1"></a>            <span class="cf">if</span>(log)<span class="fu">print</span>(attractivity)</span>
<span id="cb49-298"><a href="main-simu.html#cb49-298" tabindex="-1"></a>            attractivity[<span class="fu">is.na</span>(attractivity)] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb49-299"><a href="main-simu.html#cb49-299" tabindex="-1"></a>          }</span>
<span id="cb49-300"><a href="main-simu.html#cb49-300" tabindex="-1"></a>          </span>
<span id="cb49-301"><a href="main-simu.html#cb49-301" tabindex="-1"></a>          city <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="at">size=</span><span class="dv">1</span>, <span class="at">x=</span><span class="fu">seq_along</span>(sites), <span class="at">prob=</span>attractivity)</span>
<span id="cb49-302"><a href="main-simu.html#cb49-302" tabindex="-1"></a>          Nts[i,city] <span class="ot">&lt;-</span> Nts[i<span class="dv">-1</span>,city] <span class="sc">+</span> migrants</span>
<span id="cb49-303"><a href="main-simu.html#cb49-303" tabindex="-1"></a>          <span class="cf">if</span>(log){</span>
<span id="cb49-304"><a href="main-simu.html#cb49-304" tabindex="-1"></a>              <span class="fu">print</span>(<span class="fu">paste</span>(migrants, <span class="st">&quot;migrant from&quot;</span>, sites<span class="sc">$</span>culture[s],</span>
<span id="cb49-305"><a href="main-simu.html#cb49-305" tabindex="-1"></a>                      <span class="st">&quot;to&quot;</span>, sites<span class="sc">$</span>culture[city]))</span>
<span id="cb49-306"><a href="main-simu.html#cb49-306" tabindex="-1"></a>          }</span>
<span id="cb49-307"><a href="main-simu.html#cb49-307" tabindex="-1"></a>          havemoved <span class="ot">&lt;-</span> T</span>
<span id="cb49-308"><a href="main-simu.html#cb49-308" tabindex="-1"></a>        }</span>
<span id="cb49-309"><a href="main-simu.html#cb49-309" tabindex="-1"></a>        <span class="cf">if</span>( havemoved ){</span>
<span id="cb49-310"><a href="main-simu.html#cb49-310" tabindex="-1"></a>          </span>
<span id="cb49-311"><a href="main-simu.html#cb49-311" tabindex="-1"></a>          <span class="co">#print(paste(&quot;old spot&quot;,migrants,&quot; for &quot;,nrow(Ips[[s]])))</span></span>
<span id="cb49-312"><a href="main-simu.html#cb49-312" tabindex="-1"></a>          <span class="co">#print(paste(&quot;old new spot&quot;,migrants,&quot; for &quot;,nrow(Ips[[city]])))</span></span>
<span id="cb49-313"><a href="main-simu.html#cb49-313" tabindex="-1"></a>          </span>
<span id="cb49-314"><a href="main-simu.html#cb49-314" tabindex="-1"></a>          <span class="co">#if(city&gt;length(Ips))print(paste(&quot;problem, migrants:&quot;,migrants))</span></span>
<span id="cb49-315"><a href="main-simu.html#cb49-315" tabindex="-1"></a>          <span class="co">#print(paste(&quot;the other:&quot;,city))</span></span>
<span id="cb49-316"><a href="main-simu.html#cb49-316" tabindex="-1"></a>          Ips[<span class="fu">c</span>(s,city)] <span class="ot">&lt;-</span> <span class="fu">changePopSize</span>(</span>
<span id="cb49-317"><a href="main-simu.html#cb49-317" tabindex="-1"></a>            <span class="at">loosingPop=</span>Ips[[s]], <span class="at">winingPop=</span>Ips[[city]], <span class="at">size=</span>migrants</span>
<span id="cb49-318"><a href="main-simu.html#cb49-318" tabindex="-1"></a>          )</span>
<span id="cb49-319"><a href="main-simu.html#cb49-319" tabindex="-1"></a>          newN <span class="ot">&lt;-</span> newN <span class="sc">-</span> migrants</span>
<span id="cb49-320"><a href="main-simu.html#cb49-320" tabindex="-1"></a>          <span class="co">#print(paste(&quot;loosing &quot;,newN,&quot; vs &quot;,nrow(Ips[[s]])))</span></span>
<span id="cb49-321"><a href="main-simu.html#cb49-321" tabindex="-1"></a>          <span class="co">#print(paste(&quot;wining &quot;,newN,&quot; vs &quot;,nrow(Ips[[city]])))</span></span>
<span id="cb49-322"><a href="main-simu.html#cb49-322" tabindex="-1"></a>        }</span>
<span id="cb49-323"><a href="main-simu.html#cb49-323" tabindex="-1"></a>        </span>
<span id="cb49-324"><a href="main-simu.html#cb49-324" tabindex="-1"></a>      }</span>
<span id="cb49-325"><a href="main-simu.html#cb49-325" tabindex="-1"></a>      Nts[i,s] <span class="ot">&lt;-</span> newN</span>
<span id="cb49-326"><a href="main-simu.html#cb49-326" tabindex="-1"></a>      </span>
<span id="cb49-327"><a href="main-simu.html#cb49-327" tabindex="-1"></a>      <span class="cf">if</span> (visu){</span>
<span id="cb49-328"><a href="main-simu.html#cb49-328" tabindex="-1"></a>        <span class="do">###visualisation=========</span></span>
<span id="cb49-329"><a href="main-simu.html#cb49-329" tabindex="-1"></a>        sitescols <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span>,<span class="fu">length</span>(sites))</span>
<span id="cb49-330"><a href="main-simu.html#cb49-330" tabindex="-1"></a>        siteslwd <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span>,<span class="fu">length</span>(sites))</span>
<span id="cb49-331"><a href="main-simu.html#cb49-331" tabindex="-1"></a>        ii<span class="ot">=</span><span class="cn">NULL</span></span>
<span id="cb49-332"><a href="main-simu.html#cb49-332" tabindex="-1"></a>        <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(city)){</span>
<span id="cb49-333"><a href="main-simu.html#cb49-333" tabindex="-1"></a>          sitescols[s] <span class="ot">&lt;-</span> <span class="st">&quot;yellow&quot;</span></span>
<span id="cb49-334"><a href="main-simu.html#cb49-334" tabindex="-1"></a>          sitescols[city] <span class="ot">&lt;-</span> <span class="st">&quot;red&quot;</span></span>
<span id="cb49-335"><a href="main-simu.html#cb49-335" tabindex="-1"></a>          siteslwd[s] <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb49-336"><a href="main-simu.html#cb49-336" tabindex="-1"></a>          siteslwd[city] <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb49-337"><a href="main-simu.html#cb49-337" tabindex="-1"></a>          ii <span class="ot">&lt;-</span> <span class="fu">st_cast</span>(<span class="fu">st_combine</span>(<span class="fu">st_as_sf</span>(sites[<span class="fu">c</span>(s, city)])), <span class="st">&quot;LINESTRING&quot;</span>)</span>
<span id="cb49-338"><a href="main-simu.html#cb49-338" tabindex="-1"></a>        }</span>
<span id="cb49-339"><a href="main-simu.html#cb49-339" tabindex="-1"></a>        <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(ii)){</span>
<span id="cb49-340"><a href="main-simu.html#cb49-340" tabindex="-1"></a>          <span class="fu">plot</span>(ii ,<span class="at">add=</span>T)</span>
<span id="cb49-341"><a href="main-simu.html#cb49-341" tabindex="-1"></a>        }</span>
<span id="cb49-342"><a href="main-simu.html#cb49-342" tabindex="-1"></a>        tmp <span class="ot">&lt;-</span> Nts[i<span class="dv">-1</span>,]</span>
<span id="cb49-343"><a href="main-simu.html#cb49-343" tabindex="-1"></a>        tmp[Nts[i,]<span class="sc">&gt;</span><span class="dv">0</span>] <span class="ot">&lt;-</span> Nts[i,Nts[i,]<span class="sc">&gt;</span><span class="dv">0</span>]</span>
<span id="cb49-344"><a href="main-simu.html#cb49-344" tabindex="-1"></a>        <span class="fu">plot</span>(sites, <span class="at">cex=</span>(<span class="fu">as.integer</span>(Nts[i,]<span class="sc">&gt;</span><span class="dv">0</span>) <span class="sc">*</span> <span class="fl">0.3</span> <span class="sc">+</span> Nts[i,]<span class="sc">/</span><span class="dv">200</span>), </span>
<span id="cb49-345"><a href="main-simu.html#cb49-345" tabindex="-1"></a>             <span class="at">pch=</span><span class="dv">21</span>, <span class="at">add=</span>T, <span class="at">bg=</span><span class="fu">rainbow</span>(<span class="dv">2</span>, <span class="at">alpha=</span><span class="fl">0.6</span>)[<span class="fu">as.factor</span>(sites<span class="sc">$</span>culture)],</span>
<span id="cb49-346"><a href="main-simu.html#cb49-346" tabindex="-1"></a>             <span class="at">lwd=</span>siteslwd, <span class="at">col=</span>sitescols)</span>
<span id="cb49-347"><a href="main-simu.html#cb49-347" tabindex="-1"></a>        <span class="fu">dev.off</span>()</span>
<span id="cb49-348"><a href="main-simu.html#cb49-348" tabindex="-1"></a>        <span class="do">###=======================</span></span>
<span id="cb49-349"><a href="main-simu.html#cb49-349" tabindex="-1"></a>      }</span>
<span id="cb49-350"><a href="main-simu.html#cb49-350" tabindex="-1"></a>    }</span>
<span id="cb49-351"><a href="main-simu.html#cb49-351" tabindex="-1"></a>    <span class="cf">if</span>(visumin){</span>
<span id="cb49-352"><a href="main-simu.html#cb49-352" tabindex="-1"></a>      <span class="fu">plot</span>(sites, <span class="at">cex=</span>(<span class="fu">as.integer</span>(Nts[i,]<span class="sc">&gt;</span><span class="dv">0</span>) <span class="sc">*</span> <span class="fl">0.3</span> <span class="sc">+</span> Nts[i,]<span class="sc">/</span><span class="dv">200</span>),</span>
<span id="cb49-353"><a href="main-simu.html#cb49-353" tabindex="-1"></a>           <span class="at">pch=</span><span class="dv">21</span>, <span class="at">add=</span>T, <span class="at">bg=</span><span class="fu">rainbow</span>(<span class="dv">2</span>, <span class="at">alpha=</span><span class="fl">0.6</span>)[<span class="fu">as.factor</span>(sites<span class="sc">$</span>culture)])</span>
<span id="cb49-354"><a href="main-simu.html#cb49-354" tabindex="-1"></a>    }</span>
<span id="cb49-355"><a href="main-simu.html#cb49-355" tabindex="-1"></a>    potentialfighters <span class="ot">&lt;-</span> <span class="fu">which</span>(sites<span class="sc">$</span>culture<span class="sc">==</span><span class="st">&quot;F&quot;</span> <span class="sc">&amp;</span> Nts[i,]<span class="sc">&gt;</span><span class="dv">50</span>)</span>
<span id="cb49-356"><a href="main-simu.html#cb49-356" tabindex="-1"></a>    <span class="cf">for</span> (s <span class="cf">in</span> <span class="fu">sample</span>(<span class="at">x=</span>potentialfighters, <span class="at">size=</span><span class="fu">round</span>(<span class="fu">length</span>(potentialfighters)<span class="sc">*</span>probfight))){</span>
<span id="cb49-357"><a href="main-simu.html#cb49-357" tabindex="-1"></a>      buff <span class="ot">&lt;-</span> bufferatack</span>
<span id="cb49-358"><a href="main-simu.html#cb49-358" tabindex="-1"></a>      potentialvictims <span class="ot">&lt;-</span> <span class="fu">which</span>(sites<span class="sc">$</span>culture <span class="sc">!=</span>sites<span class="sc">$</span>culture[s] <span class="sc">&amp;</span> Nts[i,]<span class="sc">&gt;</span><span class="dv">0</span>) </span>
<span id="cb49-359"><a href="main-simu.html#cb49-359" tabindex="-1"></a>      clash <span class="ot">&lt;-</span> <span class="fu">whotouch</span>(s, sites, <span class="at">Ne=</span>Nts[i,], <span class="at">buffersize=</span>buff)</span>
<span id="cb49-360"><a href="main-simu.html#cb49-360" tabindex="-1"></a>      clash<span class="ot">=</span>clash[<span class="sc">!</span><span class="fu">is.na</span>(clash)]</span>
<span id="cb49-361"><a href="main-simu.html#cb49-361" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">length</span>(clash)<span class="sc">&gt;</span><span class="dv">0</span> ){</span>
<span id="cb49-362"><a href="main-simu.html#cb49-362" tabindex="-1"></a>        <span class="cf">if</span>(<span class="fu">length</span>(clash) <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb49-363"><a href="main-simu.html#cb49-363" tabindex="-1"></a>          attack <span class="ot">&lt;-</span> clash</span>
<span id="cb49-364"><a href="main-simu.html#cb49-364" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb49-365"><a href="main-simu.html#cb49-365" tabindex="-1"></a>          attack <span class="ot">&lt;-</span> <span class="fu">sample</span>(clash, <span class="dv">1</span>)</span>
<span id="cb49-366"><a href="main-simu.html#cb49-366" tabindex="-1"></a>        }</span>
<span id="cb49-367"><a href="main-simu.html#cb49-367" tabindex="-1"></a>        newns <span class="ot">&lt;-</span> <span class="fu">fightbetterloss</span>(<span class="at">Ne=</span>Nts[i,], <span class="at">a=</span>s, <span class="at">b=</span>attack,<span class="at">log=</span>log)</span>
<span id="cb49-368"><a href="main-simu.html#cb49-368" tabindex="-1"></a>        casualties <span class="ot">&lt;-</span> <span class="fu">sum</span>(Nts[i, <span class="fu">c</span>(s,attack)] <span class="sc">-</span> newns[<span class="fu">c</span>(s,attack)])</span>
<span id="cb49-369"><a href="main-simu.html#cb49-369" tabindex="-1"></a>        warcasualties[i] <span class="ot">&lt;-</span> casualties</span>
<span id="cb49-370"><a href="main-simu.html#cb49-370" tabindex="-1"></a>        sizew <span class="ot">&lt;-</span> casualties<span class="sc">^</span><span class="dv">2</span><span class="sc">/</span><span class="dv">4000</span></span>
<span id="cb49-371"><a href="main-simu.html#cb49-371" tabindex="-1"></a>        <span class="cf">if</span>(wplot){ <span class="co">#warplot could be use to deposit evidence of conflicts</span></span>
<span id="cb49-372"><a href="main-simu.html#cb49-372" tabindex="-1"></a>            <span class="fu">warpoints</span>(sites, s, attack, <span class="at">Ne=</span>Nts[i,],</span>
<span id="cb49-373"><a href="main-simu.html#cb49-373" tabindex="-1"></a>                  <span class="at">buffersize=</span>buff, <span class="at">sizewar=</span>sizew<span class="fl">+0.5</span>,<span class="at">plot=</span>wplot)</span>
<span id="cb49-374"><a href="main-simu.html#cb49-374" tabindex="-1"></a>        }</span>
<span id="cb49-375"><a href="main-simu.html#cb49-375" tabindex="-1"></a>        </span>
<span id="cb49-376"><a href="main-simu.html#cb49-376" tabindex="-1"></a>        <span class="co">#effectively kill people in population (should be done taking into account age pyramid to be more realistic)</span></span>
<span id="cb49-377"><a href="main-simu.html#cb49-377" tabindex="-1"></a>        Ips[[s]] <span class="ot">&lt;-</span> <span class="fu">changePopSize</span>(<span class="at">loosingPop=</span>Ips[[s]],</span>
<span id="cb49-378"><a href="main-simu.html#cb49-378" tabindex="-1"></a>                                  <span class="at">size=</span>(Nts[i,s] <span class="sc">-</span> newns[s]))</span>
<span id="cb49-379"><a href="main-simu.html#cb49-379" tabindex="-1"></a>        Ips[[attack]] <span class="ot">&lt;-</span> <span class="fu">changePopSize</span>(<span class="at">loosingPop=</span>Ips[[attack]],</span>
<span id="cb49-380"><a href="main-simu.html#cb49-380" tabindex="-1"></a>                                       <span class="at">size=</span>(Nts[i, attack] <span class="sc">-</span> newns[attack]))</span>
<span id="cb49-381"><a href="main-simu.html#cb49-381" tabindex="-1"></a>        Nts[i,] <span class="ot">&lt;-</span> newns</span>
<span id="cb49-382"><a href="main-simu.html#cb49-382" tabindex="-1"></a>        <span class="cf">if</span>(log){</span>
<span id="cb49-383"><a href="main-simu.html#cb49-383" tabindex="-1"></a>            <span class="fu">print</span>(<span class="fu">paste0</span>(<span class="st">&quot;fight : #&quot;</span>, s, <span class="st">&quot; (&quot;</span>,</span>
<span id="cb49-384"><a href="main-simu.html#cb49-384" tabindex="-1"></a>                         cultures[s], <span class="st">&quot;) left with &quot;</span>, Nts[i,s],</span>
<span id="cb49-385"><a href="main-simu.html#cb49-385" tabindex="-1"></a>                         <span class="st">&quot; (bef:&quot;</span>, Nts[i<span class="dv">-1</span>,s], <span class="st">&quot;) ind., attacked: #&quot;</span>, attack, <span class="st">&quot; (&quot;</span>,</span>
<span id="cb49-386"><a href="main-simu.html#cb49-386" tabindex="-1"></a>                         cultures[attack], <span class="st">&quot;) left with &quot;</span>, Nts[i,attack],</span>
<span id="cb49-387"><a href="main-simu.html#cb49-387" tabindex="-1"></a>                         <span class="st">&quot; (bef:&quot;</span>, Nts[i<span class="dv">-1</span>,attack],<span class="st">&quot;) ind., #death=&quot;</span>,casualties))</span>
<span id="cb49-388"><a href="main-simu.html#cb49-388" tabindex="-1"></a>        }</span>
<span id="cb49-389"><a href="main-simu.html#cb49-389" tabindex="-1"></a>      }</span>
<span id="cb49-390"><a href="main-simu.html#cb49-390" tabindex="-1"></a>    }</span>
<span id="cb49-391"><a href="main-simu.html#cb49-391" tabindex="-1"></a>    <span class="cf">if</span>(visumin <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">is.null</span>(foldervid)) <span class="fu">dev.off</span>()</span>
<span id="cb49-392"><a href="main-simu.html#cb49-392" tabindex="-1"></a>    </span>
<span id="cb49-393"><a href="main-simu.html#cb49-393" tabindex="-1"></a>  }</span>
<span id="cb49-394"><a href="main-simu.html#cb49-394" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">Nts=</span>Nts, <span class="at">warcasualties=</span>warcasualties, <span class="at">Ips=</span>Ips, <span class="at">sites=</span>sites))</span>
<span id="cb49-395"><a href="main-simu.html#cb49-395" tabindex="-1"></a>}</span></code></pre></div>
</details>
</div>
</div>
<div id="explore-simulation" class="section level2 hasAnchor" number="5.4">
<h2><span class="header-section-number">5.4</span> Explore simulation<a href="main-simu.html#explore-simulation" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The list <code>onesimu</code> contains a few interesting info:</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="main-simu.html#cb50-1" tabindex="-1"></a>Nts <span class="ot">&lt;-</span> onesimu<span class="sc">$</span>Nts <span class="co"># population at each timestep</span></span>
<span id="cb50-2"><a href="main-simu.html#cb50-2" tabindex="-1"></a>warcasualties <span class="ot">&lt;-</span> onesimu<span class="sc">$</span>warcasualties <span class="co">#death by war at each time step</span></span></code></pre></div>
<p>Nts is a <span class="math inline">\(n \times m\)</span> matrix where n is the number of time step of the simulaiton, and m the total number of sites that appears during the simulation, including the one that diseapers.</p>
<p>With this <code>Nts</code> matrix we can already see a couple of thing: <code>ncol(Nts)=</code> 122, the total number of place occupied and other in the next chunk:</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="main-simu.html#cb51-1" tabindex="-1"></a>indmax<span class="ot">=</span><span class="fu">which</span>(<span class="fu">max</span>(Nts)<span class="sc">==</span>Nts,<span class="at">arr.ind =</span> T)</span>
<span id="cb51-2"><a href="main-simu.html#cb51-2" tabindex="-1"></a>indmax[<span class="dv">1</span>] <span class="co">#timestep when biggest settlement was the biggest</span></span>
<span id="cb51-3"><a href="main-simu.html#cb51-3" tabindex="-1"></a><span class="do">## [1] 80</span></span>
<span id="cb51-4"><a href="main-simu.html#cb51-4" tabindex="-1"></a>indmax[<span class="dv">2</span>] <span class="co">#id of the biggest settlement </span></span>
<span id="cb51-5"><a href="main-simu.html#cb51-5" tabindex="-1"></a><span class="do">## [1] 3</span></span>
<span id="cb51-6"><a href="main-simu.html#cb51-6" tabindex="-1"></a><span class="fu">max</span>(Nts) <span class="co">#max number of people during the simulation</span></span>
<span id="cb51-7"><a href="main-simu.html#cb51-7" tabindex="-1"></a><span class="do">## [1] 272</span></span></code></pre></div>
<p>We can also look at the dynamics throught time, and explore how each individual sites are growing:</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="main-simu.html#cb52-1" tabindex="-1"></a>i <span class="ot">&lt;-</span> ts</span>
<span id="cb52-2"><a href="main-simu.html#cb52-2" tabindex="-1"></a><span class="fu">plot</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="at">type=</span><span class="st">&quot;n&quot;</span>, <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">0</span>,i), <span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="fu">max</span>(Nts)), <span class="at">xlab=</span><span class="st">&quot;time&quot;</span>, <span class="at">ylab=</span><span class="st">&quot;popsize&quot;</span>)</span>
<span id="cb52-3"><a href="main-simu.html#cb52-3" tabindex="-1"></a>nill <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(Nts),<span class="cf">function</span>(j)<span class="fu">lines</span>(Nts[,j]))</span>
<span id="cb52-4"><a href="main-simu.html#cb52-4" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">apply</span>(Nts, <span class="dv">1</span>, sum)[<span class="dv">1</span><span class="sc">:</span>i], <span class="at">xlab=</span><span class="st">&quot;time&quot;</span>, <span class="at">ylab=</span><span class="st">&quot;popsize&quot;</span>)</span></code></pre></div>
<div class="figure"><span style="display:block;" id="fig:explore-ex1-trajpersite"></span>
<img src="_main_files/figure-html/explore-ex1-trajpersite-1.png" alt="left: Growth of each site, right: overall growth" width="45%" /><img src="_main_files/figure-html/explore-ex1-trajpersite-2.png" alt="left: Growth of each site, right: overall growth" width="45%" />
<p class="caption">
Figure 5.2: left: Growth of each site, right: overall growth
</p>
</div>
<p>Combing <code>onesimu$site</code> with <code>Nts</code> we can compare the initial condition with the state of the worldat the end:</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="main-simu.html#cb53-1" tabindex="-1"></a><span class="fu">plot</span>(onesimu<span class="sc">$</span>site, <span class="at">cex=</span>(Nts[<span class="dv">1</span>,]<span class="sc">/</span><span class="fu">max</span>(Nts))<span class="sc">*</span><span class="dv">10</span>, <span class="at">pch=</span><span class="dv">21</span>, <span class="at">bg=</span><span class="fu">rainbow</span>(<span class="dv">2</span>, <span class="at">alpha=</span><span class="fl">0.6</span>)[<span class="fu">as.factor</span>(onesimu<span class="sc">$</span>site<span class="sc">$</span>culture)])</span>
<span id="cb53-2"><a href="main-simu.html#cb53-2" tabindex="-1"></a><span class="fu">plot</span>(onesimu<span class="sc">$</span>site, <span class="at">cex=</span>(Nts[<span class="fu">nrow</span>(Nts),]<span class="sc">/</span><span class="fu">max</span>(Nts))<span class="sc">*</span><span class="dv">10</span>, <span class="at">pch=</span><span class="dv">21</span>, <span class="at">bg=</span><span class="fu">rainbow</span>(<span class="dv">2</span>, <span class="at">alpha=</span><span class="fl">0.6</span>)[<span class="fu">as.factor</span>(onesimu<span class="sc">$</span>site<span class="sc">$</span>culture)])</span></code></pre></div>
<div class="figure"><span style="display:block;" id="fig:explore-ex1-b"></span>
<img src="_main_files/figure-html/explore-ex1-b-1.png" alt="left: sites at initialisation, right: sites at the end of the simulation" width="45%" /><img src="_main_files/figure-html/explore-ex1-b-2.png" alt="left: sites at initialisation, right: sites at the end of the simulation" width="45%" />
<p class="caption">
Figure 5.3: left: sites at initialisation, right: sites at the end of the simulation
</p>
</div>
<p>Or look at the dynamics through time but divided by culture, and comparing with the war casualties</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="main-simu.html#cb54-1" tabindex="-1"></a><span class="fu">plot</span>(warcasualties[<span class="dv">1</span><span class="sc">:</span>(i<span class="dv">-1</span>)], <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">col=</span><span class="st">&quot;green&quot;</span>, <span class="at">type=</span><span class="st">&quot;h&quot;</span>, <span class="at">yaxt=</span><span class="st">&quot;n&quot;</span>, <span class="at">ylab=</span><span class="st">&quot;&quot;</span>)  <span class="co"># Plot war casualties</span></span>
<span id="cb54-2"><a href="main-simu.html#cb54-2" tabindex="-1"></a><span class="fu">par</span>(<span class="at">new=</span>T) </span>
<span id="cb54-3"><a href="main-simu.html#cb54-3" tabindex="-1"></a><span class="fu">plot</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="at">type=</span><span class="st">&quot;n&quot;</span>, <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">0</span>,i), <span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="fu">max</span>(Nts)), <span class="at">xlab=</span><span class="st">&quot;time&quot;</span>, <span class="at">ylab=</span><span class="st">&quot;popsize&quot;</span>)</span>
<span id="cb54-4"><a href="main-simu.html#cb54-4" tabindex="-1"></a>na<span class="ot">=</span><span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(Nts),</span>
<span id="cb54-5"><a href="main-simu.html#cb54-5" tabindex="-1"></a>       <span class="cf">function</span>(i)<span class="fu">lines</span>(Nts[,i], <span class="at">col=</span><span class="fu">c</span>(<span class="st">&quot;red&quot;</span>,<span class="st">&quot;blue&quot;</span>)[<span class="fu">as.factor</span>(sites<span class="sc">$</span>culture)[i]]))</span>
<span id="cb54-6"><a href="main-simu.html#cb54-6" tabindex="-1"></a><span class="fu">plot</span>(warcasualties[<span class="dv">1</span><span class="sc">:</span>(i<span class="dv">-1</span>)], <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">col=</span><span class="st">&quot;green&quot;</span>, <span class="at">type=</span><span class="st">&quot;h&quot;</span>, <span class="at">yaxt=</span><span class="st">&quot;n&quot;</span>, <span class="at">ylab=</span><span class="st">&quot;&quot;</span>)  <span class="co"># Plot war casualties</span></span>
<span id="cb54-7"><a href="main-simu.html#cb54-7" tabindex="-1"></a><span class="fu">par</span>(<span class="at">new=</span>T)</span>
<span id="cb54-8"><a href="main-simu.html#cb54-8" tabindex="-1"></a>growF <span class="ot">&lt;-</span> <span class="fu">apply</span>(Nts[<span class="dv">1</span><span class="sc">:</span>(i<span class="dv">-1</span>), sites<span class="sc">$</span>culture<span class="sc">==</span><span class="st">&quot;F&quot;</span>,<span class="at">drop=</span>F], <span class="dv">1</span>, sum)  <span class="co"># Sum of &#39;F&#39; culture values excluding last row</span></span>
<span id="cb54-9"><a href="main-simu.html#cb54-9" tabindex="-1"></a>growHG <span class="ot">&lt;-</span> <span class="fu">apply</span>(Nts[<span class="dv">1</span><span class="sc">:</span>(i<span class="dv">-1</span>), sites<span class="sc">$</span>culture<span class="sc">==</span><span class="st">&quot;HG&quot;</span>,<span class="at">drop=</span>F], <span class="dv">1</span>, sum)  <span class="co"># Sum of &#39;HG&#39; culture values excluding last row</span></span>
<span id="cb54-10"><a href="main-simu.html#cb54-10" tabindex="-1"></a><span class="fu">plot</span>(growF, <span class="at">col=</span><span class="st">&quot;red&quot;</span>, <span class="at">type=</span><span class="st">&quot;l&quot;</span>, <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">max</span>(growF, growHG)))  <span class="co"># Plot growth of &#39;F&#39; culture</span></span>
<span id="cb54-11"><a href="main-simu.html#cb54-11" tabindex="-1"></a><span class="fu">points</span>(growHG, <span class="at">col=</span><span class="st">&quot;blue&quot;</span>, <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">type=</span><span class="st">&quot;l&quot;</span>)  <span class="co"># Add points for growth of &#39;HG&#39; culture</span></span>
<span id="cb54-12"><a href="main-simu.html#cb54-12" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">&quot;topleft&quot;</span>,<span class="at">legend=</span><span class="fu">c</span>(<span class="st">&quot;F&quot;</span>,<span class="st">&quot;HG&quot;</span>,<span class="st">&quot;war&quot;</span>),<span class="at">col=</span><span class="fu">c</span>(<span class="st">&quot;red&quot;</span>,<span class="st">&quot;blue&quot;</span>,<span class="st">&quot;green&quot;</span>),<span class="at">lwd=</span><span class="dv">1</span>,<span class="at">title=</span><span class="st">&quot;culture&quot;</span>)</span></code></pre></div>
<div class="figure"><span style="display:block;" id="fig:explore-ex1-timeandcult"></span>
<img src="_main_files/figure-html/explore-ex1-timeandcult-1.png" alt="left: Growth of eachsite for both culturles, right: combined growth" width="45%" /><img src="_main_files/figure-html/explore-ex1-timeandcult-2.png" alt="left: Growth of eachsite for both culturles, right: combined growth" width="45%" />
<p class="caption">
Figure 5.4: left: Growth of eachsite for both culturles, right: combined growth
</p>
</div>
<p>The dynamics of the simulations will heavily depend on the initial conditions and the parameters. As an example, with these parameters, it is not rare that the Farmers, due to the conflict mechanisms that we described in Chapter <a href="conflict.html#conflict">4</a>, will destroy themselves by going to war too often, as one can see in the Figure <a href="main-simu.html#fig:explore-mult">5.6</a> below. This can be avoided with the current implementation by setting a small <code>probfight</code> value to 0.1; however, it is important to remember that this could have been achieved in various ways. A more clever approach would have been for Farmers to ‘estimate’ the likelihood of them losing the battle, perhaps by fighting only <em>safe</em> battles, against much smaller settlements.</p>
<p>In order to find the right simulation, the one that will show the dynamics you want your participants to detect, you will need to play with these parameters and run several replications of the simulation in order to find the right one.</p>
<p>The script <code>scriptmini.R</code> was designed to do so for the original challenge, here we adapted it for a more generic need, to re-run simulation using the world you have generated throughout this book.</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="main-simu.html#cb55-1" tabindex="-1"></a></span>
<span id="cb55-2"><a href="main-simu.html#cb55-2" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>))</span>
<span id="cb55-3"><a href="main-simu.html#cb55-3" tabindex="-1"></a>height.ras<span class="ot">=</span><span class="fu">rast</span>(<span class="st">&quot;data_toshare/dem_raster.tiff&quot;</span>)</span>
<span id="cb55-4"><a href="main-simu.html#cb55-4" tabindex="-1"></a>height.wat<span class="ot">=</span>height.ras</span>
<span id="cb55-5"><a href="main-simu.html#cb55-5" tabindex="-1"></a>height.wat[height.wat<span class="sc">&gt;</span><span class="fu">mean</span>(height.wat[])]<span class="ot">=</span><span class="cn">NA</span></span>
<span id="cb55-6"><a href="main-simu.html#cb55-6" tabindex="-1"></a>height.groups<span class="ot">=</span>height.ras</span>
<span id="cb55-7"><a href="main-simu.html#cb55-7" tabindex="-1"></a>maxh<span class="ot">=</span><span class="fu">max</span>(height.ras[],<span class="at">na.rm=</span>T)</span>
<span id="cb55-8"><a href="main-simu.html#cb55-8" tabindex="-1"></a>height.groups[height.groups<span class="sc">&lt;</span><span class="fu">mean</span>(height.groups[])]<span class="ot">=</span><span class="cn">NA</span></span>
<span id="cb55-9"><a href="main-simu.html#cb55-9" tabindex="-1"></a>height.groups[height.groups<span class="sc">&lt;</span>(maxh<span class="sc">*</span>.<span class="dv">7</span>)]<span class="ot">=</span><span class="dv">1</span></span>
<span id="cb55-10"><a href="main-simu.html#cb55-10" tabindex="-1"></a>height.groups[height.groups<span class="sc">&gt;</span>(maxh<span class="sc">*</span>.<span class="dv">7</span>)]<span class="ot">=</span><span class="dv">200</span></span>
<span id="cb55-11"><a href="main-simu.html#cb55-11" tabindex="-1"></a>height.groups[<span class="fu">is.na</span>(height.groups)]<span class="ot">=</span><span class="sc">-</span><span class="dv">1</span></span>
<span id="cb55-12"><a href="main-simu.html#cb55-12" tabindex="-1"></a>height.poly<span class="ot">=</span><span class="fu">as.polygons</span>(height.groups)</span>
<span id="cb55-13"><a href="main-simu.html#cb55-13" tabindex="-1"></a>viable<span class="ot">=</span><span class="fu">makeValid</span>(height.poly[<span class="dv">2</span>,])</span>
<span id="cb55-14"><a href="main-simu.html#cb55-14" tabindex="-1"></a>sites<span class="ot">=</span><span class="fu">vect</span>(<span class="st">&quot;data_tmp/allsites.shp&quot;</span>)</span>
<span id="cb55-15"><a href="main-simu.html#cb55-15" tabindex="-1"></a>ts<span class="ot">=</span><span class="dv">10</span></span>
<span id="cb55-16"><a href="main-simu.html#cb55-16" tabindex="-1"></a></span>
<span id="cb55-17"><a href="main-simu.html#cb55-17" tabindex="-1"></a>allsim<span class="ot">=</span><span class="fu">list</span>()  <span class="co">#we will store te multiplesimulation, in this list to play with it, with a proper setup we stored results in files as simulation are too big to be kept in memory.</span></span>
<span id="cb55-18"><a href="main-simu.html#cb55-18" tabindex="-1"></a><span class="cf">for</span>(expname <span class="cf">in</span> <span class="fu">paste0</span>(<span class="st">&quot;exp&quot;</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>)){</span>
<span id="cb55-19"><a href="main-simu.html#cb55-19" tabindex="-1"></a></span>
<span id="cb55-20"><a href="main-simu.html#cb55-20" tabindex="-1"></a>    <span class="fu">print</span>(<span class="fu">paste0</span>(<span class="st">&quot;Starting simulation &quot;</span>,expname))</span>
<span id="cb55-21"><a href="main-simu.html#cb55-21" tabindex="-1"></a></span>
<span id="cb55-22"><a href="main-simu.html#cb55-22" tabindex="-1"></a>    onesimu<span class="ot">=</span><span class="fu">run_simulation</span> (</span>
<span id="cb55-23"><a href="main-simu.html#cb55-23" tabindex="-1"></a>                            <span class="at">sites=</span>sites, <span class="at">viable=</span>viable, <span class="at">dem=</span>height.ras,</span>
<span id="cb55-24"><a href="main-simu.html#cb55-24" tabindex="-1"></a>                            <span class="at">ressources=</span>ress,</span>
<span id="cb55-25"><a href="main-simu.html#cb55-25" tabindex="-1"></a>                            <span class="at">water=</span>height.wat,</span>
<span id="cb55-26"><a href="main-simu.html#cb55-26" tabindex="-1"></a>                            <span class="at">foldervid=</span><span class="cn">NULL</span>,</span>
<span id="cb55-27"><a href="main-simu.html#cb55-27" tabindex="-1"></a>                            <span class="at">visu=</span>F, <span class="at">visumin=</span>F,</span>
<span id="cb55-28"><a href="main-simu.html#cb55-28" tabindex="-1"></a>                            <span class="at">log=</span>F,</span>
<span id="cb55-29"><a href="main-simu.html#cb55-29" tabindex="-1"></a>                            <span class="at">ts=</span>ts, </span>
<span id="cb55-30"><a href="main-simu.html#cb55-30" tabindex="-1"></a>                            <span class="at">Kbase=</span><span class="fu">c</span>(<span class="st">&quot;HG&quot;</span><span class="ot">=</span><span class="dv">35</span>, <span class="st">&quot;F&quot;</span><span class="ot">=</span><span class="dv">110</span>), </span>
<span id="cb55-31"><a href="main-simu.html#cb55-31" tabindex="-1"></a>                            <span class="at">cul_ext=</span><span class="fu">c</span>(<span class="st">&quot;HG&quot;</span><span class="ot">=</span><span class="dv">7</span>, <span class="st">&quot;F&quot;</span><span class="ot">=</span><span class="dv">6</span>), </span>
<span id="cb55-32"><a href="main-simu.html#cb55-32" tabindex="-1"></a>                            <span class="at">penal_cul=</span><span class="fu">c</span>(<span class="st">&quot;HG&quot;</span><span class="ot">=</span><span class="dv">4</span>, <span class="st">&quot;F&quot;</span><span class="ot">=</span><span class="dv">5</span>), </span>
<span id="cb55-33"><a href="main-simu.html#cb55-33" tabindex="-1"></a>                            <span class="at">prob_birth=</span><span class="fu">c</span>(<span class="st">&quot;HG&quot;</span><span class="ot">=</span><span class="fl">0.4</span>, <span class="st">&quot;F&quot;</span><span class="ot">=</span><span class="fl">0.75</span>), </span>
<span id="cb55-34"><a href="main-simu.html#cb55-34" tabindex="-1"></a>                            <span class="at">prob_survive=</span><span class="fu">c</span>(<span class="st">&quot;HG&quot;</span><span class="ot">=</span><span class="fl">0.8</span>, <span class="st">&quot;F&quot;</span><span class="ot">=</span><span class="fl">0.65</span>), </span>
<span id="cb55-35"><a href="main-simu.html#cb55-35" tabindex="-1"></a>                            <span class="at">prob_split=</span><span class="fu">c</span>(<span class="st">&quot;HG&quot;</span><span class="ot">=</span><span class="fl">0.5</span>, <span class="st">&quot;F&quot;</span><span class="ot">=</span><span class="fl">0.6</span>), </span>
<span id="cb55-36"><a href="main-simu.html#cb55-36" tabindex="-1"></a>                            <span class="at">minimals=</span><span class="fu">c</span>(<span class="st">&quot;HG&quot;</span><span class="ot">=</span><span class="fl">0.14</span>,<span class="st">&quot;F&quot;</span><span class="ot">=</span><span class="fl">0.20</span>), </span>
<span id="cb55-37"><a href="main-simu.html#cb55-37" tabindex="-1"></a>                            <span class="at">probfight=</span><span class="fl">0.5</span>, </span>
<span id="cb55-38"><a href="main-simu.html#cb55-38" tabindex="-1"></a>                            <span class="at">bufferatack=</span><span class="dv">1000</span>, </span>
<span id="cb55-39"><a href="main-simu.html#cb55-39" tabindex="-1"></a>                            <span class="at">prob_move=</span><span class="fu">c</span>(<span class="st">&quot;HG&quot;</span><span class="ot">=</span><span class="fl">0.2</span>, <span class="st">&quot;F&quot;</span><span class="ot">=</span><span class="fl">0.1</span>) </span>
<span id="cb55-40"><a href="main-simu.html#cb55-40" tabindex="-1"></a>    )</span>
<span id="cb55-41"><a href="main-simu.html#cb55-41" tabindex="-1"></a></span>
<span id="cb55-42"><a href="main-simu.html#cb55-42" tabindex="-1"></a>    Nts<span class="ot">=</span>onesimu<span class="sc">$</span>Nts</span>
<span id="cb55-43"><a href="main-simu.html#cb55-43" tabindex="-1"></a>    warcasualties<span class="ot">=</span>onesimu<span class="sc">$</span>warcasualties</span>
<span id="cb55-44"><a href="main-simu.html#cb55-44" tabindex="-1"></a>    sites<span class="ot">=</span>onesimu<span class="sc">$</span>sites</span>
<span id="cb55-45"><a href="main-simu.html#cb55-45" tabindex="-1"></a>    i<span class="ot">=</span><span class="fu">min</span>(ts,<span class="fu">which</span>(<span class="fu">apply</span>(Nts,<span class="dv">1</span>,sum)<span class="sc">==</span><span class="dv">0</span>))</span>
<span id="cb55-46"><a href="main-simu.html#cb55-46" tabindex="-1"></a>    <span class="fu">saveRDS</span>(<span class="at">file=</span><span class="fu">file.path</span>(foldtmp,<span class="fu">paste0</span>(expname,<span class="st">&quot;_all.RDS&quot;</span>)),onesimu)</span>
<span id="cb55-47"><a href="main-simu.html#cb55-47" tabindex="-1"></a>    <span class="fu">saveRDS</span>(<span class="at">file=</span><span class="fu">file.path</span>(foldtmp,<span class="fu">paste0</span>(expname,<span class="st">&quot;_sitesRast.RDS&quot;</span>)),onesimu<span class="sc">$</span>sites)</span>
<span id="cb55-48"><a href="main-simu.html#cb55-48" tabindex="-1"></a>    <span class="fu">plotMap</span>(height.ras,height.wat,<span class="fu">paste0</span>(<span class="st">&quot;year &quot;</span>,i))</span>
<span id="cb55-49"><a href="main-simu.html#cb55-49" tabindex="-1"></a>    <span class="fu">plot</span>(sites,<span class="at">cex=</span>(<span class="fu">as.integer</span>(Nts[i,]<span class="sc">&gt;</span><span class="dv">0</span>)<span class="sc">*</span><span class="fl">0.3</span><span class="sc">+</span>Nts[i,]<span class="sc">/</span><span class="dv">200</span>),<span class="at">pch=</span><span class="dv">21</span>,<span class="at">add=</span>T,<span class="at">bg=</span><span class="fu">rainbow</span>(<span class="dv">2</span>,<span class="at">alpha=</span>.<span class="dv">6</span>)[<span class="fu">as.factor</span>(sites<span class="sc">$</span>culture)])</span>
<span id="cb55-50"><a href="main-simu.html#cb55-50" tabindex="-1"></a>    growF<span class="ot">=</span><span class="fu">apply</span>(Nts[<span class="dv">1</span><span class="sc">:</span>i,sites<span class="sc">$</span>culture<span class="sc">==</span><span class="st">&quot;F&quot;</span>],<span class="dv">1</span>,sum)</span>
<span id="cb55-51"><a href="main-simu.html#cb55-51" tabindex="-1"></a>    growHG<span class="ot">=</span><span class="fu">apply</span>(Nts[<span class="dv">1</span><span class="sc">:</span>i,sites<span class="sc">$</span>culture<span class="sc">==</span><span class="st">&quot;HG&quot;</span>],<span class="dv">1</span>,sum)</span>
<span id="cb55-52"><a href="main-simu.html#cb55-52" tabindex="-1"></a>    growT<span class="ot">=</span><span class="fu">apply</span>(Nts[<span class="dv">1</span><span class="sc">:</span>i,],<span class="dv">1</span>,sum)</span>
<span id="cb55-53"><a href="main-simu.html#cb55-53" tabindex="-1"></a></span>
<span id="cb55-54"><a href="main-simu.html#cb55-54" tabindex="-1"></a>    allsim[[expname]]<span class="ot">=</span><span class="fu">cbind.data.frame</span>(growF,growHG,growT,warcasualties[<span class="dv">1</span><span class="sc">:</span>i],<span class="fu">rep</span>(expname,i))</span>
<span id="cb55-55"><a href="main-simu.html#cb55-55" tabindex="-1"></a>}</span>
<span id="cb55-56"><a href="main-simu.html#cb55-56" tabindex="-1"></a><span class="do">## [1] &quot;Starting simulation exp1&quot;</span></span>
<span id="cb55-57"><a href="main-simu.html#cb55-57" tabindex="-1"></a><span class="do">## [1] &quot;Starting simulation exp2&quot;</span></span>
<span id="cb55-58"><a href="main-simu.html#cb55-58" tabindex="-1"></a><span class="do">## [1] &quot;Starting simulation exp3&quot;</span></span>
<span id="cb55-59"><a href="main-simu.html#cb55-59" tabindex="-1"></a><span class="do">## [1] &quot;Starting simulation exp4&quot;</span></span>
<span id="cb55-60"><a href="main-simu.html#cb55-60" tabindex="-1"></a><span class="do">## [1] &quot;Starting simulation exp5&quot;</span></span>
<span id="cb55-61"><a href="main-simu.html#cb55-61" tabindex="-1"></a><span class="do">## [1] &quot;Starting simulation exp6&quot;</span></span>
<span id="cb55-62"><a href="main-simu.html#cb55-62" tabindex="-1"></a><span class="do">## [1] &quot;Starting simulation exp7&quot;</span></span>
<span id="cb55-63"><a href="main-simu.html#cb55-63" tabindex="-1"></a><span class="do">## [1] &quot;Starting simulation exp8&quot;</span></span>
<span id="cb55-64"><a href="main-simu.html#cb55-64" tabindex="-1"></a><span class="do">## [1] &quot;Starting simulation exp9&quot;</span></span></code></pre></div>
<div class="figure"><span style="display:block;" id="fig:multi-run"></span>
<img src="_main_files/figure-html/multi-run-1.png" alt="Final state of multiple simulations with the exact same parameters." width="33%" /><img src="_main_files/figure-html/multi-run-2.png" alt="Final state of multiple simulations with the exact same parameters." width="33%" /><img src="_main_files/figure-html/multi-run-3.png" alt="Final state of multiple simulations with the exact same parameters." width="33%" /><img src="_main_files/figure-html/multi-run-4.png" alt="Final state of multiple simulations with the exact same parameters." width="33%" /><img src="_main_files/figure-html/multi-run-5.png" alt="Final state of multiple simulations with the exact same parameters." width="33%" /><img src="_main_files/figure-html/multi-run-6.png" alt="Final state of multiple simulations with the exact same parameters." width="33%" /><img src="_main_files/figure-html/multi-run-7.png" alt="Final state of multiple simulations with the exact same parameters." width="33%" /><img src="_main_files/figure-html/multi-run-8.png" alt="Final state of multiple simulations with the exact same parameters." width="33%" /><img src="_main_files/figure-html/multi-run-9.png" alt="Final state of multiple simulations with the exact same parameters." width="33%" />
<p class="caption">
Figure 5.5: Final state of multiple simulations with the exact same parameters.
</p>
</div>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="main-simu.html#cb56-1" tabindex="-1"></a>    gnmax<span class="ot">=</span><span class="fu">max</span>(<span class="fu">sapply</span>(allsim,<span class="cf">function</span>(i)<span class="fu">max</span>(i<span class="sc">$</span>growT)))</span>
<span id="cb56-2"><a href="main-simu.html#cb56-2" tabindex="-1"></a>    <span class="fu">plot</span>(<span class="dv">1</span>,i,<span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">10</span>),<span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>,gnmax),<span class="at">type=</span><span class="st">&quot;n&quot;</span>,<span class="at">main=</span><span class="st">&quot;Overal growth&quot;</span>,<span class="at">ylab=</span><span class="st">&quot;number of individual&quot;</span>,<span class="at">xlab=</span><span class="st">&quot;time&quot;</span>)</span>
<span id="cb56-3"><a href="main-simu.html#cb56-3" tabindex="-1"></a>    na<span class="ot">=</span><span class="fu">lapply</span>(allsim,<span class="cf">function</span>(i)<span class="fu">lines</span>(i<span class="sc">$</span>growT))</span>
<span id="cb56-4"><a href="main-simu.html#cb56-4" tabindex="-1"></a>    gnmax<span class="ot">=</span><span class="fu">max</span>(<span class="fu">sapply</span>(allsim,<span class="cf">function</span>(i)<span class="fu">max</span>(i[,<span class="fu">c</span>(<span class="st">&quot;growF&quot;</span>,<span class="st">&quot;growHG&quot;</span>)])))</span>
<span id="cb56-5"><a href="main-simu.html#cb56-5" tabindex="-1"></a>    <span class="fu">plot</span>(<span class="dv">1</span>,i,<span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">10</span>),<span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>,gnmax),<span class="at">type=</span><span class="st">&quot;n&quot;</span>,<span class="at">main=</span><span class="st">&quot;Growth per culture&quot;</span>,<span class="at">ylab=</span><span class="st">&quot;number of individual&quot;</span>,<span class="at">xlab=</span><span class="st">&quot;time&quot;</span>)</span>
<span id="cb56-6"><a href="main-simu.html#cb56-6" tabindex="-1"></a>    na<span class="ot">=</span><span class="fu">lapply</span>(allsim,<span class="cf">function</span>(i){<span class="fu">lines</span>(i<span class="sc">$</span>growHG,<span class="at">col=</span><span class="st">&quot;red&quot;</span>);<span class="fu">lines</span>(i<span class="sc">$</span>growF,<span class="at">col=</span><span class="st">&quot;green&quot;</span>)})</span>
<span id="cb56-7"><a href="main-simu.html#cb56-7" tabindex="-1"></a>    gnmax<span class="ot">=</span><span class="fu">max</span>(<span class="fu">sapply</span>(allsim,<span class="cf">function</span>(i)<span class="fu">max</span>(i<span class="sc">$</span>warcasualties)))</span>
<span id="cb56-8"><a href="main-simu.html#cb56-8" tabindex="-1"></a>    <span class="fu">plot</span>(<span class="dv">1</span>,i,<span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">10</span>),<span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>,gnmax),<span class="at">type=</span><span class="st">&quot;n&quot;</span>,<span class="at">main=</span><span class="st">&quot;War Casualties&quot;</span>,<span class="at">ylab=</span><span class="st">&quot;number of individual&quot;</span>,<span class="at">xlab=</span><span class="st">&quot;time&quot;</span>)</span>
<span id="cb56-9"><a href="main-simu.html#cb56-9" tabindex="-1"></a>    na<span class="ot">=</span><span class="fu">lapply</span>(allsim,<span class="cf">function</span>(i)<span class="fu">lines</span>(i<span class="sc">$</span>warcasualties))</span></code></pre></div>
<div class="figure"><span style="display:block;" id="fig:explore-mult"></span>
<img src="_main_files/figure-html/explore-mult-1.png" alt="Comparing multiple runs" width="33%" /><img src="_main_files/figure-html/explore-mult-2.png" alt="Comparing multiple runs" width="33%" /><img src="_main_files/figure-html/explore-mult-3.png" alt="Comparing multiple runs" width="33%" />
<p class="caption">
Figure 5.6: Comparing multiple runs
</p>
</div>
<p>Once you found the right simulation we can use the populations this simulaiton created to generated an archaeological records, based on law we will describe in the next chapter.</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="conflict.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="recgen.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
